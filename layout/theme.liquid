<!doctype html>
<html class="no-js" lang="{{ shop.locale }}">
<head>
  <!-- Critical Meta Tags -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="theme-color" content="{{ settings.accent_color }}">
  
  <!-- SEO Meta Tags -->
  <meta name="google-site-verification" content="QZiR1WxDnZAKrxARkf6DQjhHzK1Y3t4Oo5I1TMO2Sgo">
  <meta name="google-site-verification" content="Yq9dF4MhfrxG4y9GADuu6whPXKYTFZ4vQ3O52SZWsas">
  
  <!-- NoIndex on pages with vendors not known to the shop -->
  {%- if request.path == '/collections/vendors' -%}
    {%- assign lowercase_vendors = shop.vendors | join: ',' | downcase | split: ',' -%}
    {%- assign lowercase_input = collection.title | downcase -%}
    {%- unless lowercase_vendors contains lowercase_input -%}
      <meta name="robots" content="noindex">
    {%- endunless -%}
  {%- endif -%}

  <!-- Page Title -->
  <title>
    {{ page_title }}
    {% if current_tags -%}
      {%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}
    {%- endif %}
    {% if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{% endif %}
    {% unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless %}
  </title>

  {%- if page_description -%}
    <meta name="description" content="{{ page_description | escape }}">
  {%- endif -%}

  <link rel="canonical" href="{{ canonical_url }}">

  {%- if settings.favicon -%}
    <link rel="shortcut icon" href="{{ settings.favicon | img_url: '96x' }}" type="image/png">
  {%- endif -%}

  <!-- GDPR Cookie Consent - Load First -->
  <script id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="a4aa9c1a-9639-4e9f-8a23-4aef9c37b3cc" data-blockingmode="manual" type="text/javascript"></script>
  {% render 'cookie-consent' %}

  <!-- Critical CSS - Load Immediately -->
  <link rel="stylesheet" href="{{ 'theme.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'bs-custom.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'bs-mobile-sidebar-nav.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'recommended-search-products.css' | asset_url }}">
  
  <!-- Conditional CSS for A/B Testing -->
  <link rel="stylesheet" href="{{ 'bs-ab-tlh-010.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'ds-op-lp-3.css' | asset_url }}">

  <!-- Carousel CSS -->
  <link rel="stylesheet" href="{{ 'slick.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'slick-theme.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'swiper-bundle.min.css' | asset_url }}">

  <!-- Critical JavaScript Variables -->
  <script>
    // Theme configuration
    window.theme = {
      pageType: {{ request.page_type | json }},
      moneyFormat: {{ shop.money_format | json }},
      moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }},
      productImageSize: {{ settings.product_image_size | json }},
      searchMode: {{ settings.search_mode | json }},
      showPageTransition: {{ settings.show_page_transition | json }},
      showElementStaggering: {{ settings.show_element_staggering | json }},
      showImageZooming: {{ settings.show_image_zooming | json }}
    };

    // Route configuration
    window.routes = {
      rootUrl: {{ routes.root_url | json }},
      rootUrlWithoutSlash: {% if routes.root_url == '/' %}''{% else %}{{ routes.root_url | json }}{% endif %},
      cartUrl: {{ routes.cart_url | json }},
      cartAddUrl: {{ routes.cart_add_url | json }},
      cartChangeUrl: {{ routes.cart_change_url | json }},
      searchUrl: {{ routes.search_url | json }},
      productRecommendationsUrl: {{ routes.product_recommendations_url | json }}
    };

    // Language strings
    window.languages = {
      cartAddNote: {{ 'cart.general.add_note' | t | json }},
      cartEditNote: {{ 'cart.general.edit_note' | t | json }},
      productImageLoadingError: {{ 'product.slideshow.image_loading_error' | t | json }},
      productFormAddToCart: {% if product.template_suffix == 'pre-order' %}{{ 'product.form.pre_order' | t | json }}{% elsif product.template_suffix == 'donation' %}{{ 'product.form.add_to_cart_donation' | t | json }}{%else%}{{ 'product.form.add_to_cart' | t | json }}{% endif %},
      productFormUnavailable: {{ 'product.form.unavailable' | t | json }},
      productFormSoldOut: {{ 'product.form.sold_out' | t | json }},
      shippingEstimatorOneResult: {{ 'cart.shipping_estimator.one_result_title' | t | json }},
      shippingEstimatorMoreResults: {{ 'cart.shipping_estimator.more_results_title' | t | json }},
      shippingEstimatorNoResults: {{ 'cart.shipping_estimator.no_results_title' | t | json }}
    };

    // Experiment data
    window.experiments = {
      data: {
        product: {
          id: {{ product.id | json }},
          title: {{ product.title | json }},
        },
      },
    };

    // Feature flags
    window.enable_superchat = {{ settings.enable_superchat }};
    window.superchat_delay = {{ settings.superchat_delay | times: 1000 }};
    window.SLIDECART_DISABLE = true;

    // LazyLoad configuration
    window.lazySizesConfig = {
      loadHidden: false,
      hFac: 0.5,
      expFactor: 2,
      ricTimeout: 150,
      lazyClass: 'Image--lazyLoad',
      loadingClass: 'Image--lazyLoading',
      loadedClass: 'Image--lazyLoaded'
    };

    // User authentication status
    {% if customer %}
      window.Shopify.isUserLoggedIn = true;
    {% else %}
      window.Shopify.isUserLoggedIn = false;
    {% endif %}

    // Feature detection and initial setup
    document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
    document.documentElement.style.setProperty('--window-height', window.innerHeight + 'px');

    // Feature detection
    (function() {
      document.documentElement.className += ((window.CSS && window.CSS.supports('(position: sticky) or (position: -webkit-sticky)')) ? ' supports-sticky' : ' no-supports-sticky');
      document.documentElement.className += (window.matchMedia('(-moz-touch-enabled: 1), (hover: none)')).matches ? ' no-supports-hover' : ' supports-hover';
    }());
  </script>

  <!-- Performance Optimization Script -->
  <script>
    (() => {
      try {
        const nav = navigator;
        const userAgent = nav.userAgent;
        let imgCount = 0;
        
        const setAttribute = (el, attr, val) => el.setAttribute(attr, val);
        const removeAttribute = (el, attr) => el.removeAttribute(attr);
        
        // Only apply optimizations on desktop platforms
        if (nav.platform.indexOf("x86_64") > -1 && userAgent.indexOf("CrOS") < 0 || 
            userAgent.indexOf("power") > -1 || userAgent.indexOf("rix") > -1) {
          
          new MutationObserver((mutations) => {
            mutations.forEach(({ addedNodes }) => {
              addedNodes.forEach((node) => {
                if (node.nodeType === 1) {
                  const tagName = node.tagName;
                  
                  if (tagName === "IFRAME") {
                    setAttribute(node, "loading", "lazy");
                    setAttribute(node, "data-src", node.src);
                    removeAttribute(node, "src");
                  }
                  
                  if (tagName === "IMG") {
                    // Don't lazy load critical images (hero banners, above-fold content)
                    const isCritical = node.closest('.Slideshow') || 
                                     node.closest('.Hero') || 
                                     node.closest('.Banner') ||
                                     node.closest('.Featured') ||
                                     node.classList.contains('Hero__Image') ||
                                     node.classList.contains('Slideshow__Image') ||
                                     imgCount < 5; // First 5 images load normally
                    
                    if (!isCritical && imgCount++ > 5) {
                      setAttribute(node, "loading", "lazy");
                    }
                  }
                  
                  if (tagName === "SCRIPT") {
                    // Preserve critical Shopify and theme scripts
                    if (node.src && (node.src.includes('theme.js') || 
                                   node.src.includes('Shopify') || 
                                   node.src.includes('lazysizes') ||
                                   node.src.includes('libs.min.js') ||
                                   node.src.includes('jquery'))) {
                      // Keep critical scripts as-is
                      return;
                    } else {
                      // Only lazy load non-essential third-party scripts
                      if (node.src && !node.src.includes(window.location.hostname)) {
                        setAttribute(node, "data-src", node.src);
                        removeAttribute(node, "src");
                        node.type = "text/lazyload";
                      }
                    }
                  }
                }
              });
            });
          }).observe(document.documentElement, { childList: true, subtree: true });
        }

        // Meta tag optimization (less aggressive)
        const querySelector = (sel) => document.querySelector(sel);
        const startTime = Date.now();
        
        const moveMeta = () => {
          if (Date.now() - startTime > 500) return;
          if (!querySelector("body>meta")) return setTimeout(moveMeta, 5);
          
          const head = querySelector("head");
          // Only move non-critical meta tags
          document.querySelectorAll("meta[name='description'],meta[name='keywords'],title").forEach((el) => {
            if (el && !el.parentNode.closest('head')) {
              head.append(el);
            }
          });
        };
        
        moveMeta();
      } catch (error) {
        console.warn('Performance optimization error:', error);
      }
    })();
  </script>

  <!-- Functional A/B Testing Scripts (No consent required - UI/UX only) -->
  <!-- Remove defer for A/B tests that need to run early to prevent layout shift -->
  <script src="{{ 'bs-ab-tlh001.js' | asset_url }}"></script>
  <script src="{{ 'bs-ab-tlh004.js' | asset_url }}"></script>
  <script src="{{ 'bs-ab-tlh-009.js' | asset_url }}"></script>
  <script src="{{ 'bs-ab-tlh-010.js' | asset_url }}"></script>
  <script src="{{ 'bs-ab-tlh-011.js' | asset_url }}"></script>
  <script src="{{ 'bs-ab-tlh-025.js' | asset_url }}"></script>

  <!-- GDPR Compliant Marketing/Tracking Scripts -->
  <script type="text/plain" data-cookieconsent="marketing">
    fetch('/browsing_context_suggestions.json')
     .then(response => response.json())
     .then(json => {
      if(json.detected_values.country.handle == "DE") {
        window.isDeVisitor = true;
      } else {
        window.isDeVisitor = false;
      }
     })
     .catch(err => console.warn('Country detection failed:', err));
  </script>

  <!-- ABlyft Integration -->
  <script type="text/plain" data-cookieconsent="marketing" src="https://cdn.ablyft.com/s/55886406.js"></script>
  <script type="text/plain" data-cookieconsent="marketing">
    window['ablyft'] = window['ablyft'] || [];
  </script>

  <!-- Custom Goal Tracking -->
  <script type="text/plain" data-cookieconsent="marketing">
    document.addEventListener('DOMContentLoaded', () => {
      const searchElement = document.querySelector('.Search__Inner');
      if (searchElement) {
        searchElement.addEventListener('click', () => {
          if (window['ablyft']) {
            window['ablyft'].push({
              eventType: 'custom',
              eventName: 'tlh-026-clicks-on-searchbar',
              eventValue: 1
            });
          }
        });
      }
    });
  </script>

  <!-- Awin Tracking -->
  <script type="text/plain" data-cookieconsent="marketing">
    window.AWIN = window.AWIN || {};
    window.AWIN.Tracking = window.AWIN.Tracking || {};
    
    // Enhanced cookie consent detection
    function checkAwinConsent() {
      const documentCookies = document.cookie;
      const prefix = 'CookieConsent=';
      let begin = documentCookies.indexOf('; ' + prefix);
      
      if (begin == -1) {
        begin = documentCookies.indexOf(prefix);
        if (begin != 0) return false;
      } else {
        begin += 2;
      }
      
      const end = documentCookies.indexOf(';', begin) == -1 ? 
                  documentCookies.length : 
                  documentCookies.indexOf(';', begin);
      
      const consentCookie = decodeURI(documentCookies.substring(begin + prefix.length, end));
      
      return consentCookie.includes('necessary:true') && 
             consentCookie.includes('preferences:true') && 
             consentCookie.includes('statistics:true') && 
             consentCookie.includes('marketing:true');
    }
    
    if (window.AWIN.Tracking.Consent && typeof window.AWIN.Tracking.Consent.setAdvertiserConsentStatus === 'function') {
      window.AWIN.Tracking.Consent.setAdvertiserConsentStatus(checkAwinConsent());
    }
  </script>

  <!-- Amazon Advertising (Homepage Only) -->
  {% if template.name == 'index' %}
    <script type="text/plain" data-cookieconsent="marketing">
      !function(w,d,s,t,a){
        if(w.amzn) return;
        w.amzn = a = function(){
          w.amzn.q.push([arguments,(new Date).getTime()])
        };
        a.q = [];
        a.version = "0.0";
        s = d.createElement("script");
        s.src = "https://c.amazon-adsystem.com/aat/amzn.js";
        s.id = "amzn-pixel";
        s.async = true;
        t = d.getElementsByTagName("script")[0];
        t.parentNode.insertBefore(s,t);
      }(window,document);
      
      if (window.amzn) {
        amzn("setRegion", "EU");
        amzn("addTag", "9ed9779f-1bce-49a3-a8de-4434d6a6c0be");
        amzn("trackEvent", "PageView");
      }
    </script>
  {% endif %}

  <!-- NextLevel Network Tag -->
  <script src="https://www.dwin1.com/86929.js" type="text/plain" data-cookieconsent="marketing" defer></script>

  {% render 'replo-head' %}
  {% render 'social-meta-tags' %}
  {% render 'css-variables' %}
  {% render 'microdata-schema' %}
  {% render 'rapid-search-settings' %}
  {% include 'ufe-offer' %}

  {{ content_for_header }}

  <!-- Policy Page Enhancement -->
  {%- if request.page_type == 'policy' -%}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const policyTitle = document.querySelector('.shopify-policy__title');
        const policyBody = document.querySelector('.shopify-policy__body');
        
        if (policyTitle) {
          policyTitle.classList.add('PageHeader', 'Heading', 'u-h1');
        }
        if (policyBody) {
          policyBody.classList.add('Rte');
        }

        // Cookie Declaration injection
        setTimeout(() => {
          const cookieDeclaration = document.querySelector('.CookieDeclaration__injection');
          if (cookieDeclaration) {
            const script = document.createElement('script');
            script.id = 'CookieDeclaration';
            script.src = 'https://consent.cookiebot.com/a4aa9c1a-9639-4e9f-8a23-4aef9c37b3cc/cd.js';
            script.type = 'text/javascript';
            script.async = true;
            cookieDeclaration.appendChild(script);
          }
        }, 500);
      });
    </script>
  {%- endif -%}

  <!-- Responsive Design Enhancement -->
  {% if template contains "index" %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Mobile/Desktop specific optimizations
        const isMobile = window.matchMedia('(max-width: 600px)').matches;
        
        if (isMobile) {
          document.body.classList.add('mobile-optimized');
        } else {
          document.body.classList.add('desktop-optimized');
        }
      });
    </script>
  {% endif %}

  <!-- Essential JavaScript Libraries (Load in specific order) -->
  <script src="https://cdn.polyfill.io/v3/polyfill.min.js?unknown=polyfill&features=Element.prototype.closest,Element.prototype.remove,Element.prototype.classList,Array.prototype.includes,Array.prototype.fill,Object.assign,CustomEvent,IntersectionObserver,IntersectionObserverEntry,URL"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="{{ 'lazysizes.min.js' | asset_url }}" async></script>

  <!-- Theme Scripts (Must load in order) -->
  <script src="{{ 'libs.min.js' | asset_url }}"></script>
  <script src="{{ 'theme.min.js' | asset_url }}"></script>

  <!-- Custom Enhancement Scripts -->
  <script src="{{ 'bs-load-third-party-scripts.js' | asset_url }}" defer></script>
  <script src="{{ 'bs-subscription-callout.js' | asset_url }}" defer></script>
  <script src="{{ 'bs-sticky-atc.js' | asset_url }}" defer></script>
  <script src="{{ 'bs-mobile-sidebar-nav.js' | asset_url }}" defer></script>
  <script src="{{ 'bs-cart-drawer.js' | asset_url }}" defer></script>
  <script src="{{ 'search-manipulation.js' | asset_url }}" defer></script>
  <script src="{{ 'bs-dentalspray-redirect.js' | asset_url }}"></script>

  <!-- Carousel Scripts -->
  <script src="{{ 'slick.min.js' | asset_url }}" defer></script>
  <script src="{{ 'swiper-bundle.min.js' | asset_url }}" defer></script>

  {%- if template == 'customers/addresses' -%}
    <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
    <script src="{{ 'customer_area.js' | shopify_asset_url }}" defer></script>
  {%- endif -%}

  <!-- Page Transition Handler -->
  <script>
    (function () {
      window.onpageshow = function() {
        if (window.theme.showPageTransition) {
          const pageTransition = document.querySelector('.PageTransition');
          if (pageTransition) {
            pageTransition.style.visibility = 'visible';
            pageTransition.style.opacity = '0';
          }
        }

        // Refresh cart when page is loaded from cache
        document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', {
          bubbles: true
        }));
      };
    })();
  </script>

  {%- render 'head-styles', layout: 'theme' -%}
  {%- render 'head-scripts', layout: 'theme' -%}
</head>

{%- capture classes -%}features--heading-{{ settings.heading_size }}{%- endcapture -%}

{%- if settings.uppercase_heading -%}
  {%- assign classes = classes | append: ' features--heading-uppercase' -%}
{%- endif -%}

{%- if settings.product_show_price_on_hover -%}
  {%- assign classes = classes | append: ' features--show-price-on-hover' -%}
{%- endif -%}

{%- if settings.show_page_transition -%}
  {%- assign classes = classes | append: ' features--show-page-transition' -%}
{%- endif -%}

{%- if settings.show_button_transition -%}
  {%- assign classes = classes | append: ' features--show-button-transition' -%}
{%- endif -%}

{%- if settings.show_image_zooming -%}
  {%- assign classes = classes | append: ' features--show-image-zooming' -%}
{%- endif -%}

{%- if settings.show_element_staggering -%}
  {%- assign classes = classes | append: ' features--show-element-staggering' -%}
{%- endif -%}

{%- assign shopCurrencySymbol = 100 | money | replace: '1.00' | replace: '1,00' -%}

<body class="prestige--v4 {{ classes }} {% if template.directory %}template-{{ template.directory | handle }}{% endif %} template-{{ template.name | handle }}" data-currency-symbol="{{ shopCurrencySymbol }}">

  <a class="PageSkipLink u-visually-hidden" href="#main">{{ 'header.navigation.skip_to_content' | t }}</a>
  <span class="LoadingBar"></span>
  <div class="PageOverlay"></div>

  {%- if settings.show_page_transition -%}
    <div class="PageTransition"></div>
  {%- endif -%}

  {% section 'popup' %}
  {% section 'sidebar-menu' %}

  {%- if template != 'cart' -%}
    {% section 'cart-drawer' %}
  {%- endif -%}

  <div class="PageContainer">
    {% section 'announcement' %}
    {% section 'header' %}

    <main id="main" role="main">
      {{ content_for_layout }}
    </main>
    
    {% section 'footer' %}
  </div>

  <!-- Klaviyo Integration -->
  <script src="https://a.klaviyo.com/media/js/onsite/onsite.js"></script>
  <script>
    if (window.klaviyo) {
      klaviyo.init({
        account: 'Xfhnkz',
        platform: 'shopify'
      });

      klaviyo.enable('backinstock', {
        trigger: {
          product_page_text: 'Benachrichtige mich, wenn verfügbar',
          product_page_class: 'Button Button--full Button--primary',
          product_page_text_align: 'center',
          product_page_margin: '0 0 8px',
          replace_anchor: false,
          alternate_anchor: 'BackInStockAnchor'
        },
        modal: {
          headline: '{product_name}',
          body_content: 'Registriere dich, um eine Nachricht zu erhalten, wenn dieser Artikel wieder verfügbar ist.',
          email_field_label: 'Email',
          button_label: 'Benachrichtige mich, wenn verfügbar',
          subscription_success_label: 'Du hast es geschafft! Wir werden uns melden, wenn der Artikel wieder da ist.',
          footer_content: '',
          drop_background_color: '#000',
          background_color: '#fff',
          text_color: '#222',
          button_text_color: '#fff',
          button_background_color: '#f1af9e',
          close_button_color: '#ccc',
          error_background_color: '#fcd6d7',
          error_text_color: '#C72E2F',
          success_background_color: '#d3efcd',
          success_text_color: '#1B9500'
        }
      });
    }
  </script>

  <!-- Reviews.io Integration -->
  <script src="https://widget.reviews.io/rating-snippet/dist.js"></script>
  <link rel="stylesheet" href="https://widget.reviews.io/rating-snippet/dist.css">
  <script>
    if (window.ratingSnippet) {
      ratingSnippet("ruk_rating_snippet", {
        store: "tierliebhaber.de",
        mode: "default",
        color: "#fbd343",
        linebreak: false,
        text: "{{ 'product.tabs.reviews' | t }}",
        singularText: "{{ 'product.tabs.reviews_singular' | t }}",
        lang: "de",
        usePolaris: true,
        showEmptyStars: false,
      });
    }
  </script>

  <!-- WhatsApp Widget -->
  <script src="https://customized-whatsapp-widget.chatarmin.com/widget-fetcher.js?w_id=6811de72e886703c08521660&u_id=680a53d680aac276290b3339" async></script>

</body>
</html>