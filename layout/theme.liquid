<!doctype html>
<html class="no-js" lang="{{ shop.locale }}">
<head>

<!-- GDPR Cookie Consent - AUTO mode (professional standard) -->
<script id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="a4aa9c1a-9639-4e9f-8a23-4aef9c37b3cc" data-blockingmode="auto" type="text/javascript"></script>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="{{ settings.accent_color }}">

<!-- Google site verification -->
<meta name="google-site-verification" content="QZiR1WxDnZAKrxARkf6DQjhHzK1Y3t4Oo5I1TMO2Sgo">
<meta name="google-site-verification" content="Yq9dF4MhfrxG4y9GADuu6whPXKYTFZ4vQ3O52SZWsas">

<!-- Core CSS (functional - no consent needed) -->
<link rel="stylesheet" href="{{ 'theme.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'bs-custom.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'bs-mobile-sidebar-nav.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'recommended-search-products.css' | asset_url }}">

<!-- A/B Testing CSS (no tracking data) -->
<link rel="stylesheet" href="{{ 'bs-ab-tlh-010.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'ds-op-lp-3.css' | asset_url }}">

<!-- UI Libraries (functional - no consent needed) -->
<link rel="stylesheet" href="{{ 'slick.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'slick-theme.css' | asset_url }}">
<link rel="stylesheet" href="{{ 'swiper-bundle.min.css' | asset_url }}">

<!-- Page Meta -->
{%- if page_description -%}
  <meta name="description" content="{{ page_description | escape }}">
{%- endif -%}
<link rel="canonical" href="{{ canonical_url }}">
{%- if settings.favicon -%}
  <link rel="shortcut icon" href="{{ settings.favicon | img_url: '96x' }}" type="image/png">
{%- endif -%}

<!-- NoIndex on unknown vendor pages -->
{%- if request.path == '/collections/vendors' -%}
  {%- assign lowercase_vendors = shop.vendors | join: ',' | downcase | split: ',' -%}
  {%- assign lowercase_input = collection.title | downcase -%}
  {%- unless lowercase_vendors contains lowercase_input -%}
    <meta name="robots" content="noindex">
  {%- endunless -%}
{%- endif -%}

<!-- Page Title -->
<title>
  {{ page_title }}
  {% if current_tags -%}
    {%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}
  {%- endif %}
  {% if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{% endif %}
  {% unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless %}
</title>

{% render 'social-meta-tags' %}
{% render 'css-variables' %}

<!-- Shopify Content -->
{{ content_for_header }}
{% render 'cookie-consent' %}

<!-- Essential JavaScript Configuration -->
<script>
  // Feature flags and globals (functional - no consent needed)
  window.SLIDECART_DISABLE = true;
  window.experiments = {
    data: {
      product: {
        id: {{ product.id | json }},
        title: {{ product.title | json }}
      }
    }
  };
  window.enable_superchat = {{ settings.enable_superchat }};
  window.superchat_delay = {{ settings.superchat_delay | times: 1000 }};

  // LazyLoad configuration
  window.lazySizesConfig = {
    loadHidden: false,
    hFac: 0.5,
    expFactor: 2,
    ricTimeout: 150,
    lazyClass: 'Image--lazyLoad',
    loadingClass: 'Image--lazyLoading',
    loadedClass: 'Image--lazyLoaded'
  };
</script>

<!-- A/B Testing Scripts (functional UI changes - no tracking) -->
<script src="{{ 'bs-ab-tlh001.js' | asset_url }}"></script>
<script src="{{ 'bs-ab-tlh004.js' | asset_url }}"></script>
<script src="{{ 'bs-ab-tlh-009.js' | asset_url }}"></script>
<script src="{{ 'bs-ab-tlh-010.js' | asset_url }}"></script>
<script src="{{ 'bs-ab-tlh-011.js' | asset_url }}"></script>
<script src="{{ 'bs-ab-tlh-025.js' | asset_url }}"></script>

<!-- Essential Libraries (no consent needed) -->
<script src="{{ 'jquery.min.js' | asset_url }}"></script>
<script src="{{ 'lazysizes.min.js' | asset_url }}" async></script>
<script src="https://cdn.polyfill.io/v3/polyfill.min.js?unknown=polyfill&features=Element.prototype.closest,Element.prototype.remove,Element.prototype.classList,Array.prototype.includes,Array.prototype.fill,Object.assign,CustomEvent,IntersectionObserver,IntersectionObserverEntry,URL" defer></script>

<!-- Theme Scripts (functional - no consent needed) -->
<script src="{{ 'libs.min.js' | asset_url }}" defer></script>
<script src="{{ 'theme.min.js' | asset_url }}" defer></script>
<script src="{{ 'slick.min.js' | asset_url }}" defer></script>
<script src="{{ 'swiper-bundle.min.js' | asset_url }}" defer></script>

<!-- Enhancement Scripts (functional - no consent needed) -->
<script src="{{ 'bs-load-third-party-scripts.js' | asset_url }}" defer></script>
<script src="{{ 'bs-subscription-callout.js' | asset_url }}" defer></script>
<script src="{{ 'bs-sticky-atc.js' | asset_url }}" defer></script>
<script src="{{ 'bs-mobile-sidebar-nav.js' | asset_url }}" defer></script>
<script src="{{ 'bs-cart-drawer.js' | asset_url }}" defer></script>
<script src="{{ 'search-manipulation.js' | asset_url }}" defer></script>
<script src="{{ 'bs-dentalspray-redirect.js' | asset_url }}" defer></script>

<!-- Customer Area Scripts (Shopify functional) -->
{%- if template == 'customers/addresses' -%}
  <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
  <script src="{{ 'customer_area.js' | shopify_asset_url }}" defer></script>
{%- endif -%}

<!-- MARKETING SCRIPTS - Properly Gated -->

<!-- Country Detection for ABlyft - GATED -->
<script type="text/plain" data-cookieconsent="marketing">
  fetch('/browsing_context_suggestions.json')
    .then(response => response.json())
    .then(json => {
      if (json.detected_values.country.handle == "DE") {
        window.isDeVisitor = true;
      } else {
        window.isDeVisitor = false;
      }
    })
    .catch(err => console.warn('Country detection failed:', err));
</script>

<!-- ABlyft Tracking - GATED -->
<script type="text/plain" data-cookieconsent="marketing" src="https://cdn.ablyft.com/s/55886406.js"></script>
<script type="text/plain" data-cookieconsent="marketing">
  window['ablyft'] = window['ablyft'] || [];
</script>

<!-- Search Analytics - GATED -->
<script type="text/plain" data-cookieconsent="marketing">
  document.addEventListener('DOMContentLoaded', () => {
    const searchElement = document.querySelector('.Search__Inner');
    if (searchElement) {
      searchElement.addEventListener('click', () => {
        if (window['ablyft']) {
          window['ablyft'].push({
            eventType: 'custom',
            eventName: 'tlh-026-clicks-on-searchbar',
            eventValue: 1
          });
        }
      });
    }
  });
</script>

<!-- Awin Affiliate Tracking - GATED -->
<script type="text/plain" data-cookieconsent="marketing">
  var AWIN = AWIN || {};
  AWIN.Tracking = AWIN.Tracking || {};
  AWIN.Tracking.AdvertiserConsent = false;

  // Get Cookie
  let documentCookies = document.cookie;
  let prefix = 'CookieConsent' + '=';
  let begin = documentCookies.indexOf('; ' + prefix);
  let end;

  if (begin == -1) {
    begin = documentCookies.indexOf(prefix);
    if (begin != 0) return null;
  } else {
    begin += 2;
    end = document.cookie.indexOf(';', begin);
    if (end == -1) {
      end = documentCookies.length;
    }
  }
  
  const consentCookie = decodeURI(documentCookies.substring(begin + prefix.length, end));
  if (consentCookie.includes('necessary:true') && 
      consentCookie.includes('preferences:true') && 
      consentCookie.includes('statistics:true') && 
      consentCookie.includes('marketing:true')) {
    if (AWIN.Tracking.Consent && typeof AWIN.Tracking.Consent.setAdvertiserConsentStatus === 'function') {
      AWIN.Tracking.Consent.setAdvertiserConsentStatus(true);
    }
  } else {
    if (AWIN.Tracking.Consent && typeof AWIN.Tracking.Consent.setAdvertiserConsentStatus === 'function') {
      AWIN.Tracking.Consent.setAdvertiserConsentStatus(false);
    }
  }
</script>

<!-- Amazon Advertising (Homepage Only) - GATED -->
{% if template.name == 'index' %}
  <script type="text/plain" data-cookieconsent="marketing">
    !function(w,d,s,t,a){if(w.amzn)return;w.amzn=a=function(){w.amzn.q.push([arguments,(new Date).getTime()])};a.q=[];a.version="0.0";s=d.createElement("script");s.src="https://c.amazon-adsystem.com/aat/amzn.js";s.id="amzn-pixel";s.async=true;t=d.getElementsByTagName("script")[0];t.parentNode.insertBefore(s,t)}(window,document);
    amzn("setRegion", "EU");
    amzn("addTag", "9ed9779f-1bce-49a3-a8de-4434d6a6c0be");
    amzn("trackEvent", "PageView");
  </script>
{% endif %}

<!-- Replo Landing Page Analytics - GATED -->
<script type="text/plain" data-cookieconsent="marketing">
  {% render 'replo-head' %}
</script>

{% render 'rapid-search-settings' %}
{% render 'head-styles', layout: 'theme' %}
{% render 'head-scripts', layout: 'theme' %}
{% render 'microdata-schema' %}
{% include 'ufe-offer' %}

</head>

{%- capture classes -%}features--heading-{{ settings.heading_size }}{%- endcapture -%}

{%- if settings.uppercase_heading -%}
  {%- assign classes = classes | append: ' features--heading-uppercase' -%}
{%- endif -%}

{%- if settings.product_show_price_on_hover -%}
  {%- assign classes = classes | append: ' features--show-price-on-hover' -%}
{%- endif -%}

{%- if settings.show_page_transition -%}
  {%- assign classes = classes | append: ' features--show-page-transition' -%}
{%- endif -%}

{%- if settings.show_button_transition -%}
  {%- assign classes = classes | append: ' features--show-button-transition' -%}
{%- endif -%}

{%- if settings.show_image_zooming -%}
  {%- assign classes = classes | append: ' features--show-image-zooming' -%}
{%- endif -%}

{%- if settings.show_element_staggering -%}
  {%- assign classes = classes | append: ' features--show-element-staggering' -%}
{%- endif -%}

{%- assign shopCurrencySymbol = 100 | money | replace: '1.00' | replace: '1,00' -%}

<body
  class="prestige--v4 {{ classes }} {% if template.directory %}template-{{ template.directory | handle }}{% endif %} template-{{ template.name | handle }}"
  data-currency-symbol="{{ shopCurrencySymbol }}"
>

  <a class="PageSkipLink u-visually-hidden" href="#main">{{ 'header.navigation.skip_to_content' | t }}</a>
  <span class="LoadingBar"></span>
  <div class="PageOverlay"></div>

  {%- if settings.show_page_transition -%}
    <div class="PageTransition"></div>
  {%- endif -%}

  {% section 'popup' %}
  {% section 'sidebar-menu' %}

  {%- if template != 'cart' -%}
    {% section 'cart-drawer' %}
  {%- endif -%}

  <div class="PageContainer">
    {% section 'announcement' %}
    {% section 'header' %}

    <main id="main" role="main">
      {{ content_for_layout }}
    </main>
    {% section 'footer' %}
  </div>

  <!-- Theme Configuration -->
  <script>
    (function () {
      window.theme = {
        pageType: {{ request.page_type | json }},
        moneyFormat: {{ shop.money_format | json }},
        moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }},
        productImageSize: {{ settings.product_image_size | json }},
        searchMode: {{ settings.search_mode | json }},
        showPageTransition: {{ settings.show_page_transition | json }},
        showElementStaggering: {{ settings.show_element_staggering | json }},
        showImageZooming: {{ settings.show_image_zooming | json }}
      };

      window.routes = {
        rootUrl: {{ routes.root_url | json }},
        rootUrlWithoutSlash: {% if routes.root_url == '/' %}''{% else %}{{ routes.root_url | json }}{% endif %},
        cartUrl: {{ routes.cart_url | json }},
        cartAddUrl: {{ routes.cart_add_url | json }},
        cartChangeUrl: {{ routes.cart_change_url | json }},
        searchUrl: {{ routes.search_url | json }},
        productRecommendationsUrl: {{ routes.product_recommendations_url | json }}
      };

      window.languages = {
        cartAddNote: {{ 'cart.general.add_note' | t | json }},
        cartEditNote: {{ 'cart.general.edit_note' | t | json }},
        productImageLoadingError: {{ 'product.slideshow.image_loading_error' | t | json }},
        productFormAddToCart: {% if product.template_suffix == 'pre-order' %}{{ 'product.form.pre_order' | t | json }}{% elsif product.template_suffix == 'donation' %}{{ 'product.form.add_to_cart_donation' | t | json }}{%else%}{{ 'product.form.add_to_cart' | t | json }}{% endif %},
        productFormUnavailable: {{ 'product.form.unavailable' | t | json }},
        productFormSoldOut: {{ 'product.form.sold_out' | t | json }},
        shippingEstimatorOneResult: {{ 'cart.shipping_estimator.one_result_title' | t | json }},
        shippingEstimatorMoreResults: {{ 'cart.shipping_estimator.more_results_title' | t | json }},
        shippingEstimatorNoResults: {{ 'cart.shipping_estimator.no_results_title' | t | json }}
      };

      {% if customer %}
        window.Shopify.isUserLoggedIn = true;
      {% else %}
        window.Shopify.isUserLoggedIn = false;
      {% endif %}

      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      document.documentElement.style.setProperty('--window-height', window.innerHeight + 'px');

      // Feature detection
      (function() {
        document.documentElement.className += ((window.CSS && window.CSS.supports('(position: sticky) or (position: -webkit-sticky)')) ? ' supports-sticky' : ' no-supports-sticky');
        document.documentElement.className += (window.matchMedia('(-moz-touch-enabled: 1), (hover: none)')).matches ? ' no-supports-hover' : ' supports-hover';
      }());

      // Page transition handling
      window.onpageshow = function() {
        if (window.theme.showPageTransition) {
          var pageTransition = document.querySelector('.PageTransition');
          if (pageTransition) {
            pageTransition.style.visibility = 'visible';
            pageTransition.style.opacity = '0';
          }
        }

        // When the page is loaded from the cache, we have to reload the cart content
        document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', {
          bubbles: true
        }));
      };
    })();
  </script>

  <!-- Policy Page Enhancement -->
  {% if request.page_type == 'policy' %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const policyTitle = document.querySelector('.shopify-policy__title');
        const policyBody = document.querySelector('.shopify-policy__body');
        
        if (policyTitle) {
          policyTitle.classList.add('PageHeader', 'Heading', 'u-h1');
        }
        if (policyBody) {
          policyBody.classList.add('Rte');
        }

        setTimeout(() => {
          const cookieDeclaration = document.querySelector('.CookieDeclaration__injection');
          if (cookieDeclaration) {
            const cookieDeclarationScript = document.createElement('script');
            cookieDeclarationScript.setAttribute('id','CookieDeclaration');
            cookieDeclarationScript.setAttribute('src','https://consent.cookiebot.com/a4aa9c1a-9639-4e9f-8a23-4aef9c37b3cc/cd.js');
            cookieDeclarationScript.setAttribute('type','text/javascript');
            cookieDeclarationScript.setAttribute('async','true');
            cookieDeclaration.appendChild(cookieDeclarationScript);
          }
        }, 500);
      });
    </script>
  {% endif %}

  <!-- MARKETING INTEGRATIONS - All Properly Gated -->

  <!-- NextLevel Network Tracking - GATED -->
  <script src="https://www.dwin1.com/86929.js" type="text/plain" data-cookieconsent="marketing" defer></script>

  <!-- Reviews.io Integration - No consent required (functional) -->
  <script src="https://widget.reviews.io/rating-snippet/dist.js"></script>
  <link rel="stylesheet" href="https://widget.reviews.io/rating-snippet/dist.css">
  <script>
    if (window.ratingSnippet) {
      ratingSnippet("ruk_rating_snippet", {
        store: "tierliebhaber.de",
        mode: "default",
        color: "#fbd343",
        linebreak: false,
        text: "{{ 'product.tabs.reviews' | t }}",
        singularText: "{{ 'product.tabs.reviews_singular' | t }}",
        lang: "de",
        usePolaris: true,
        showEmptyStars: false,
      });
    }
  </script>

  <!-- WhatsApp Widget - GATED -->
  <script type="text/plain" data-cookieconsent="marketing">
    const whatsappScript = document.createElement('script');
    whatsappScript.src = 'https://customized-whatsapp-widget.chatarmin.com/widget-fetcher.js?w_id=6811de72e886703c08521660&u_id=680a53d680aac276290b3339';
    whatsappScript.async = true;
    document.body.appendChild(whatsappScript);
  </script>

</body>
</html>