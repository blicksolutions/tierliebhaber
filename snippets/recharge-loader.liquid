<style>
/* ========================================
   RECHARGE SKELETON LOADER
   Dynamic height - 290px nur wÃ¤hrend Loading
   ======================================== */

/* Container: min-height nur wenn leer (loading) */
.rc-widget-injection-parent {
  position: relative;
}

/* Skeleton: Fixed height nur wÃ¤hrend Loading */
.rc-widget-injection-parent:empty {
  min-height: 350px;
  background: #f8f8f8;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* Wenn ReCharge geladen ist: Auto height */
.rc-widget-injection-parent:not(:empty) {
  min-height: auto;
}

/* CRITICAL: Hide Variants SOFORT wenn ReCharge Container existiert */
body:has(.rc-widget-injection-parent) .ProductForm__Variants {
  display: none !important;
}

/* Animated loading bar oben */
.rc-widget-injection-parent:empty::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, transparent, #3578b5, transparent);
  animation: loadingBar 1.5s infinite;
}

@keyframes loadingBar {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Loading Text in der Mitte */
.rc-widget-injection-parent:empty::after {
  content: 'Abo-Optionen werden geladen...';
  color: #999;
  font-size: 14px;
  font-weight: 400;
}

/* Smooth Fade-In wenn ReCharge lÃ¤dt */
.rc-widget-injection-parent > * {
  animation: slideInUp 0.4s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Optional: Alternative shimmer effect */

.rc-widget-injection-parent:empty {
  background: linear-gradient(
    90deg,
    #f0f0f0 0%,
    #e0e0e0 20%,
    #f0f0f0 40%,
    #f0f0f0 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}


</style>

<script>

// ========================================
// RECHARGE SMART OVERRIDE - FINAL VERSION
// CSS versteckt Variants SOFORT
// JavaScript lÃ¤dt ReCharge schnell
// ========================================

(function() {
  'use strict';

  console.log('ðŸ§  ReCharge Smart Override - Final Version');

  // Check if in Theme Editor
  const isThemeEditor = window.self !== window.top || 
                        window.location.search.includes('preview_theme_id') ||
                        document.body.classList.contains('template-password');
  
  if (isThemeEditor) {
    console.log('ðŸŽ¨ Theme Editor detected - applying instant CSS only');
    // CSS wird trotzdem injiziert am Ende des Scripts
  }

  const originalAddEventListener = window.addEventListener;
  const originalAttachEvent = window.attachEvent;
  let rechargeLoadCalled = false;

  // Funktion um zu prÃ¼fen ob ReCharge bereit ist
  function isRechargeReady() {
    if (typeof Shopify === 'undefined' || !Shopify.routes) {
      return false;
    }

    const productJson = document.querySelector('[data-product-json], script[type="application/json"][data-product]');
    if (!productJson) {
      return false;
    }

    const productForm = document.querySelector('form[action*="/cart/add"], .ProductForm, [data-product-form]');
    if (!productForm) {
      return false;
    }

    const rechargeContainer = document.querySelector('.rc-widget-injection-parent, #rc-container, [data-recharge-container]');
    if (!rechargeContainer) {
      return false;
    }

    return true;
  }

  function loadRechargeWhenReady(listenerFunction) {
    if (isRechargeReady()) {
      console.log('âš¡ Dependencies ready - loading ReCharge immediately!');
      setTimeout(listenerFunction, 0);
      return;
    }

    if (document.readyState === 'loading') {
      console.log('â³ Waiting for DOMContentLoaded...');
      originalAddEventListener.call(window, 'DOMContentLoaded', function() {
        console.log('âœ… DOMContentLoaded fired');
        
        if (isRechargeReady()) {
          console.log('âš¡ Loading ReCharge now!');
          listenerFunction();
        } else {
          waitForDependencies(listenerFunction);
        }
      });
    } else if (document.readyState === 'interactive') {
      console.log('ðŸ“Š DOM interactive - checking dependencies...');
      
      if (isRechargeReady()) {
        console.log('âš¡ Loading ReCharge now!');
        setTimeout(listenerFunction, 0);
      } else {
        waitForDependencies(listenerFunction);
      }
    } else {
      console.log('ðŸ“¦ Page already fully loaded');
      listenerFunction();
    }
  }

  function waitForDependencies(listenerFunction) {
    let checkCount = 0;
    const maxChecks = 20;

    const checkInterval = setInterval(() => {
      checkCount++;
      
      if (isRechargeReady()) {
        console.log(`âœ… Dependencies ready after ${checkCount * 100}ms`);
        clearInterval(checkInterval);
        listenerFunction();
      } else if (checkCount >= maxChecks) {
        console.warn('âš ï¸ Timeout waiting for dependencies - loading anyway');
        clearInterval(checkInterval);
        listenerFunction();
      }
    }, 100);

    const observer = new MutationObserver(() => {
      if (isRechargeReady()) {
        console.log('âœ… Dependencies detected via MutationObserver');
        clearInterval(checkInterval);
        observer.disconnect();
        listenerFunction();
      }
    });

    observer.observe(document.documentElement, {
      childList: true,
      subtree: true
    });

    setTimeout(() => {
      observer.disconnect();
    }, maxChecks * 100);
  }

  // Override addEventListener (skip in Theme Editor)
  if (!isThemeEditor) {
    window.addEventListener = function(type, listener, options) {
      
      if (type === 'load' && !rechargeLoadCalled) {
        const listenerStr = listener.toString();
        
        if (listenerStr.includes('rechargecdn.com') || 
            listenerStr.includes('widget.min.js') ||
            listenerStr.includes('asyncLoad')) {
          
          console.log('ðŸŽ¯ Intercepted ReCharge App Embed load event!');
          console.log('ðŸ§  Using smart loading (waiting for dependencies)');
          
          rechargeLoadCalled = true;
          loadRechargeWhenReady(listener);
          
          return;
        }
      }

      return originalAddEventListener.call(window, type, listener, options);
    };

    // Override attachEvent
    if (originalAttachEvent) {
      window.attachEvent = function(event, listener) {
        
        if (event === 'onload' && !rechargeLoadCalled) {
          const listenerStr = listener.toString();
          
          if (listenerStr.includes('rechargecdn.com') || 
              listenerStr.includes('widget.min.js') ||
              listenerStr.includes('asyncLoad')) {
            
            console.log('ðŸŽ¯ Intercepted ReCharge attachEvent!');
            rechargeLoadCalled = true;
            loadRechargeWhenReady(listener);
            
            return;
          }
        }

        return originalAttachEvent.call(window, event, listener);
      };
    }

    console.log('âœ… ReCharge Smart Override active');
  }
  
  console.log('â„¹ï¸ Standard Variants werden via CSS versteckt (instant)');

})();

// CSS fÃ¼r instant hide + animations + dynamic height
if (!document.getElementById('recharge-smart-styles')) {
  const style = document.createElement('style');
  style.id = 'recharge-smart-styles';
  style.textContent = `
    /* ReCharge Container - Dynamic Height */
    .rc-widget-injection-parent:empty {
      min-height: 350px; /* Nur wÃ¤hrend Loading */
    }
    
    .rc-widget-injection-parent:not(:empty) {
      min-height: auto; /* Auto wenn geladen */
    }
    
    /* CRITICAL: Hide Variants INSTANTLY */
    body:has(.rc-widget-injection-parent) .ProductForm__Variants {
      display: none !important;
    }
    
    /* Fade in animation */
    .rc-widget-injection-parent > * {
      animation: fadeInRecharge 0.4s ease-out;
    }
    
    @keyframes fadeInRecharge {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  `;
  document.head.appendChild(style);
}

console.log('âœ… ReCharge instant hide CSS injected');

</script>


