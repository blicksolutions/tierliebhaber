<style>
/* ========================================
   RECHARGE SKELETON LOADER - PRODUCTION
   ======================================== */

.rc-widget-injection-parent {
  position: relative;
}

.rc-widget-injection-parent:empty {
  min-height: 318px;
  background: #f8f8f8;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

@media screen and (max-width: 1007px) {
  .rc-widget-injection-parent:empty {
    min-height: 308px;
  }
}

.rc-widget-injection-parent:not(:empty) {
  min-height: auto;
}

body:has(.rc-widget-injection-parent) .ProductForm__Variants {
  display: none !important;
}

.rc-widget-injection-parent:empty::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, transparent, #3578b5, transparent);
  animation: loadingBar 1.5s infinite;
}

@keyframes loadingBar {
  0% { left: -100%; }
  100% { left: 100%; }
}

.rc-widget-injection-parent:empty::after {
  content: 'Abo-Optionen werden geladen...';
  color: #999;
  font-size: 14px;
  font-weight: 400;
}

.rc-widget-injection-parent > * {
  animation: slideInUp 0.4s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
(function() {
  'use strict';

  const isThemeEditor = window.self !== window.top || 
                        window.location.search.includes('preview_theme_id');
  
  if (isThemeEditor) {
    const loadRechargeDirectly = () => {
      if (document.querySelector('script[src*="rechargecdn.com"]')) return;
      
      const script = document.createElement('script');
      script.src = 'https://static.rechargecdn.com/assets/js/widget.min.js?shop=tierliebhaber-animagus.myshopify.com';
      script.async = true;
      document.head.appendChild(script);
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadRechargeDirectly);
    } else {
      setTimeout(loadRechargeDirectly, 500);
    }
  }

  const originalAddEventListener = window.addEventListener;
  const originalAttachEvent = window.attachEvent;
  let rechargeLoadCalled = false;

  function isRechargeReady() {
    if (typeof Shopify === 'undefined' || !Shopify.routes) return false;
    if (!document.querySelector('[data-product-json], script[type="application/json"][data-product]')) return false;
    if (!document.querySelector('form[action*="/cart/add"], .ProductForm, [data-product-form]')) return false;
    if (!document.querySelector('.rc-widget-injection-parent, #rc-container, [data-recharge-container]')) return false;
    return true;
  }

  function loadRechargeWhenReady(listenerFunction) {
    if (isRechargeReady()) {
      setTimeout(listenerFunction, 0);
      return;
    }

    if (document.readyState === 'loading') {
      originalAddEventListener.call(window, 'DOMContentLoaded', function() {
        if (isRechargeReady()) {
          listenerFunction();
        } else {
          waitForDependencies(listenerFunction);
        }
      });
    } else if (document.readyState === 'interactive') {
      if (isRechargeReady()) {
        setTimeout(listenerFunction, 0);
      } else {
        waitForDependencies(listenerFunction);
      }
    } else {
      listenerFunction();
    }
  }

  function waitForDependencies(listenerFunction) {
    let checkCount = 0;
    const maxChecks = 20;

    const checkInterval = setInterval(() => {
      checkCount++;
      
      if (isRechargeReady()) {
        clearInterval(checkInterval);
        listenerFunction();
      } else if (checkCount >= maxChecks) {
        clearInterval(checkInterval);
        listenerFunction();
      }
    }, 100);

    const observer = new MutationObserver(() => {
      if (isRechargeReady()) {
        clearInterval(checkInterval);
        observer.disconnect();
        listenerFunction();
      }
    });

    observer.observe(document.documentElement, {
      childList: true,
      subtree: true
    });

    setTimeout(() => observer.disconnect(), maxChecks * 100);
  }

  window.addEventListener = function(type, listener, options) {
    if (type === 'load' && !rechargeLoadCalled) {
      const listenerStr = listener.toString();
      
      if (listenerStr.includes('rechargecdn.com') || 
          listenerStr.includes('widget.min.js') ||
          listenerStr.includes('asyncLoad')) {
        
        rechargeLoadCalled = true;
        loadRechargeWhenReady(listener);
        return;
      }
    }
    return originalAddEventListener.call(window, type, listener, options);
  };

  if (originalAttachEvent) {
    window.attachEvent = function(event, listener) {
      if (event === 'onload' && !rechargeLoadCalled) {
        const listenerStr = listener.toString();
        
        if (listenerStr.includes('rechargecdn.com') || 
            listenerStr.includes('widget.min.js') ||
            listenerStr.includes('asyncLoad')) {
          
          rechargeLoadCalled = true;
          loadRechargeWhenReady(listener);
          return;
        }
      }
      return originalAttachEvent.call(window, event, listener);
    };
  }
})();

if (!document.getElementById('recharge-smart-styles')) {
  const style = document.createElement('style');
  style.id = 'recharge-smart-styles';
  style.textContent = `
    .rc-widget-injection-parent:empty {
      min-height: 318px;
    }
    @media screen and (max-width: 1007px) {
      .rc-widget-injection-parent:empty {
        min-height: 308px;
      }
    }
    .rc-widget-injection-parent:not(:empty) {
      min-height: auto;
    }
    body:has(.rc-widget-injection-parent) .ProductForm__Variants {
      display: none !important;
    }
    .rc-widget-injection-parent > * {
      animation: fadeInRecharge 0.4s ease-out;
    }
    @keyframes fadeInRecharge {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  `;
  document.head.appendChild(style);
}
</script>
