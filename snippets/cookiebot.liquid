<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Beobachte DOM-Änderungen durch Cookiebot
    const observer = new MutationObserver(() => {
      const declineBtn = document.querySelector('#CybotCookiebotDialogBodyButtonDecline');
      const textContainer = document.querySelector('#CybotCookiebotDialogBodyContentText');

      if (declineBtn && textContainer && !textContainer.querySelector('#CybotCookiebotDialogBodyButtonDecline')) {
        // Verschiebe den Button in den Textbereich
        textContainer.appendChild(declineBtn);
        declineBtn.style.display = 'block'; // falls nötig sicherstellen, dass er sichtbar bleibt
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  });
  (function () {
    // ---- Toggle debug logs in console
    window.DEBUG_CONSENT = window.DEBUG_CONSENT || false;
    const log = (...args) => {
      if (window.DEBUG_CONSENT) {
        try {
          console.log('[consent]', ...args);
        } catch (e) {}
      }
    };

    // ---- Consent check (Cookiebot first, cookie fallback second)
    function hasConsent(cat) {
      try {
        if (window.Cookiebot && Cookiebot.consent) {
          if (cat === 'marketing') return !!Cookiebot.consent.marketing;
          if (cat === 'statistics') return !!Cookiebot.consent.statistics;
          if (cat === 'preferences') return !!Cookiebot.consent.preferences;
          if (cat === 'necessary') return true;
          return false;
        }
        // Fallback: parse "CookieConsent" cookie (Cookiebot writes this)
        const row = document.cookie.split('; ').find((r) => r.startsWith('CookieConsent='));
        if (!row) return false;
        const v = decodeURIComponent(row.split('=')[1] || '');
        const map = {
          marketing: /marketing:true/.test(v),
          statistics: /statistics:true/.test(v),
          preferences: /preferences:true/.test(v),
        };
        return !!map[cat];
      } catch (e) {
        return false;
      }
    }

    // ---- Guard marketing cookies (Elevar/Klaviyo) until consent
    const cookieDesc =
      Object.getOwnPropertyDescriptor(Document.prototype, 'cookie') ||
      Object.getOwnPropertyDescriptor(HTMLDocument.prototype, 'cookie');
    if (cookieDesc && cookieDesc.set) {
      Object.defineProperty(document, 'cookie', {
        configurable: true,
        enumerable: true,
        get: cookieDesc.get,
        set: function (v) {
          try {
            // Add any other marketing cookies you want to guard here:
            if (v && (/_Elevar/i.test(v) || /__kla_id/i.test(v) || /_ke=/.test(v) || /KL_FORMS/.test(v))) {
              if (!hasConsent('marketing')) {
                log('blocked cookie (marketing)', v);
                return;
              }
            }
          } catch (e) {}
          return cookieDesc.set.call(this, v);
        },
      });
    }

    // ---- Domain → category map for script gating
    const MAP = {
      'polyfill-fastly.net': 'preferences', // Functional
      'error-analytics-sessions-production.shopifysvc.com': 'statistics', // Shopify Error Analytics
    };
    const domains = Object.keys(MAP);

    const hostOf = (u) => {
      try {
        return new URL(u, location.href).hostname;
      } catch (e) {
        return '';
      }
    };
    const catFor = (u) => {
      const h = hostOf(u);
      if (!h) return null;
      for (const d of domains) {
        if (h === d || h.endsWith('.' + d)) return MAP[d];
      }
      return null;
    };
    const shouldBlock = (u) => {
      const c = catFor(u || '');
      return c ? !hasConsent(c) : false;
    };

    const pending = [];
    function copyAttrs(el) {
      const o = {};
      for (const a of el.attributes || []) o[a.name] = a.value;
      return o;
    }
    function queue(el, src) {
      pending.push({
        src,
        attrs: copyAttrs(el),
        async: el.async,
        defer: el.defer,
        nonce: el.nonce,
        referrerPolicy: el.referrerPolicy,
        crossOrigin: el.crossOrigin,
        integrity: el.integrity,
      });
      log('blocked script', src, 'cat:', catFor(src));
    }
    function release() {
      for (let i = pending.length - 1; i >= 0; i--) {
        const r = pending[i],
          c = catFor(r.src || '');
        if (!c || hasConsent(c)) {
          const s = document.createElement('script');
          if (r.nonce) s.nonce = r.nonce;
          if (r.async != null) s.async = r.async;
          if (r.defer != null) s.defer = r.defer;
          if (r.referrerPolicy) s.referrerPolicy = r.referrerPolicy;
          if (r.crossOrigin) s.crossOrigin = r.crossOrigin;
          if (r.integrity) s.integrity = r.integrity;
          for (const [k, v] of Object.entries(r.attrs || {})) {
            const kk = k.toLowerCase();
            if (
              !['src', 'async', 'defer', 'nonce', 'referrerpolicy', 'crossorigin', 'integrity', 'type'].includes(kk)
            ) {
              try {
                s.setAttribute(k, v);
              } catch (e) {}
            }
          }
          s.src = r.src;
          (document.head || document.documentElement).appendChild(s);
          log('released script', r.src, c);
          pending.splice(i, 1);
        }
      }
    }

    // Intercept dynamic script loads (createElement, appendChild/insertBefore, and .src setter)
    const OrigCreate = document.createElement;
    const OrigAppend = Element.prototype.appendChild;
    const OrigBefore = Element.prototype.insertBefore;
    const OrigSetAttr = Element.prototype.setAttribute;

    document.createElement = function (tag) {
      const el = OrigCreate.call(document, tag);
      if (String(tag).toLowerCase() === 'script') {
        el.setAttribute = function (name, value) {
          if (String(name).toLowerCase() === 'src' && shouldBlock(value)) {
            queue(el, value);
            return;
          }
          return OrigSetAttr.call(el, name, value);
        };
      }
      return el;
    };
    Element.prototype.appendChild = function (ch) {
      if (ch && ch.tagName === 'SCRIPT') {
        const src = ch.getAttribute && ch.getAttribute('src');
        if (src && shouldBlock(src)) {
          queue(ch, src);
          return ch;
        }
      }
      return OrigAppend.call(this, ch);
    };
    Element.prototype.insertBefore = function (n, r) {
      if (n && n.tagName === 'SCRIPT') {
        const src = n.getAttribute && n.getAttribute('src');
        if (src && shouldBlock(src)) {
          queue(n, src);
          return n;
        }
      }
      return OrigBefore.call(this, n, r);
    };

    const srcDesc = Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype, 'src');
    if (srcDesc && srcDesc.set) {
      Object.defineProperty(HTMLScriptElement.prototype, 'src', {
        configurable: true,
        get() {
          return srcDesc.get.call(this);
        },
        set(v) {
          if (shouldBlock(v)) {
            queue(this, v);
            return v;
          }
          return srcDesc.set.call(this, v);
        },
      });
    }

    // Release when Cookiebot reports consent (or fallback timer)
    window.addEventListener('CookiebotOnConsentReady', release);
    window.addEventListener('CookiebotOnAccept', release);
    window.addEventListener('CookiebotOnDecline', release);
    setTimeout(release, 2000);
  })();
</script>

<script
  id="Cookiebot"
  src="https://consent.cookiebot.com/uc.js"
  data-cbid="a4aa9c1a-9639-4e9f-8a23-4aef9c37b3cc"
  data-blockingmode="manual"
  type="text/javascript"
></script>

<!-- Block Vimeo Start until Markting Consent (edit Michael Müller 9.9.25) -->

<script>
  (function () {
    /* ---------- Helpers ---------- */
    const log = (...a) => {
      try {
        console.debug('[VIMEO CONSENT]', ...a);
      } catch (e) {}
    };

    function hasMarketingConsent() {
      try {
        if (typeof Cookiebot !== 'undefined') {
          if (Cookiebot.consents && typeof Cookiebot.consents.marketing === 'boolean')
            return Cookiebot.consents.marketing;
          if (Cookiebot.consent && typeof Cookiebot.consent.marketing === 'boolean') return Cookiebot.consent.marketing;
        }
        // Fallback: CookieConsent-String von Cookiebot
        const cc = document.cookie.split('; ').find((r) => r.startsWith('CookieConsent='));
        return cc ? decodeURIComponent(cc.split('=')[1]).includes('marketing:true') : false;
      } catch (e) {
        return false;
      }
    }

    function isVimeoIframe(node) {
      return node && node.tagName === 'IFRAME' && /(^|\/\/)(player\.)?vimeo\.com/i.test(node.src || '');
    }

    function makePlaceholder(src) {
      const wrap = document.createElement('div');
      wrap.className = 'vimeo-consent-placeholder';
      wrap.setAttribute('data-vimeo-src', src);
      wrap.innerHTML = `
      <div class="vimeo-consent-box">
        <div class="vimeo-consent-title">Vimeo-Video blockiert</div>
        <div class="vimeo-consent-text">Zum Abspielen bitte Marketing-Cookies zulassen.</div>
        <div class="vimeo-consent-actions">
          <button type="button" class="vimeo-consent-allow">Marketing akzeptieren & Video laden</button>
          <button type="button" class="vimeo-consent-settings">Einstellungen öffnen</button>
        </div>
      </div>
    `;
      wrap.querySelector('.vimeo-consent-allow').addEventListener('click', function () {
        // Im manuellen Modus öffnen wir einfach das Cookiebot-Dialogfenster;
        // der User kann dort Marketing aktivieren. Danach greifen die Events unten.
        if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.show === 'function') {
          Cookiebot.renew();
        } else {
          alert('Bitte Marketing-Cookies in den Cookie-Einstellungen aktivieren.');
        }
      });
      wrap.querySelector('.vimeo-consent-settings').addEventListener('click', function () {
        if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.show === 'function') Cookiebot.renew();
      });
      return wrap;
    }

    function replaceIframeWithPlaceholder(iframe) {
      if (iframe.hasAttribute('data-consent-exempt')) return; // Opt-out für einzelne iFrames
      const src = iframe.src;
      const ph = makePlaceholder(src);
      iframe.parentNode.insertBefore(ph, iframe);
      iframe.parentNode.removeChild(iframe);
    }

    function restoreVimeoFromPlaceholder(ph) {
      const src = ph.getAttribute('data-vimeo-src');
      if (!src) return;
      const f = document.createElement('iframe');
      f.src = src;
      f.width = ph.getAttribute('data-width') || '100%';
      f.height = ph.getAttribute('data-height') || '100%';
      f.setAttribute('frameborder', '0');
      f.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
      f.setAttribute('allowfullscreen', '');
      ph.parentNode.replaceChild(f, ph);
    }

    function blockAllVimeoIframes(context) {
      const root = context || document;
      root.querySelectorAll('iframe[src*="vimeo.com"]').forEach((ifr) => {
        if (!hasMarketingConsent()) replaceIframeWithPlaceholder(ifr);
      });
    }

    function restoreAllPlaceholders() {
      if (!hasMarketingConsent()) return;
      document.querySelectorAll('.vimeo-consent-placeholder').forEach(restoreVimeoFromPlaceholder);
    }

    // Initial: bestehende iFrames prüfen
    if (!hasMarketingConsent()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => blockAllVimeoIframes(document));
      } else {
        blockAllVimeoIframes(document);
      }
    }

    // Dynamisch nachgeladene iFrames abfangen
    new MutationObserver((ml) => {
      if (hasMarketingConsent()) return;
      for (const m of ml)
        for (const n of m.addedNodes) {
          if (isVimeoIframe(n)) replaceIframeWithPlaceholder(n);
          else if (n.querySelectorAll)
            n.querySelectorAll('iframe[src*="vimeo.com"]').forEach(replaceIframeWithPlaceholder);
        }
    }).observe(document.documentElement, { childList: true, subtree: true });

    // Nach Einwilligung: automatisch freischalten
    function enforceVimeoConsentState() {
      if (hasMarketingConsent()) {
        // Zustimmung vorhanden -> Platzhalter in echte Iframes zurückverwandeln
        restoreAllPlaceholders();
      } else {
        // Keine Zustimmung -> alle vorhandenen Vimeo-Iframes in Platzhalter tauschen
        document.querySelectorAll('iframe[src*="vimeo.com"]').forEach(replaceIframeWithPlaceholder);
      }
    }

    // Alte Listener entfernen/überschreiben und durch diese Drei ersetzen:
    window.addEventListener('CookiebotOnConsentReady', enforceVimeoConsentState);
    window.addEventListener('CookiebotOnAccept', enforceVimeoConsentState);
    window.addEventListener('CookiebotOnDecline', enforceVimeoConsentState);

    // Optional (falls euer Setup dieses Event feuert, z. B. bei erneuter Auswahl im Dialog):
    window.addEventListener('CookiebotOnDialogInit', enforceVimeoConsentState);

    // Minimalstyles (kannst du ins CSS auslagern)
    const css = `
  .vimeo-consent-placeholder{border:1px solid #e5e5e5; background:#fafafa; padding:16px; text-align:center; margin:8px 0;}
  .vimeo-consent-title{font-weight:600; margin-bottom:4px;}
  .vimeo-consent-text{font-size:14px; color:#444; margin-bottom:10px;}
  .vimeo-consent-actions button{margin:0 4px; padding:8px 12px; cursor:pointer;}
  .vimeo-consent-actions .vimeo-consent-allow{background:#222; color:#fff; border:0;}
  .vimeo-consent-actions .vimeo-consent-settings{background:#fff; color:#222; border:1px solid #222;}
  `;
    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
  })();
</script>

<!-- Version mit Poster Video, Auto Accept und PLay auf Play Button (edit Michael Müller 9.9.25) -->

{% comment %}
  <script>
  (function(){
    /* =================== Konfiguration =================== */
    // Dein Standard-Placeholder (z.B. aus Assets). Am besten 16:9.
    const DEFAULT_POSTER = '{{ "vimeo-placeholder.jpg" | asset_url }}'; // oder absolute URL
    // Fallback-Aspect-Ratio falls das Original-IFRAME keine Maße hat:
    const FALLBACK_ASPECT = '16 / 9';

    /* =================== Helpers / Consent =================== */
    const log = (...a)=>{ try{ console.debug('[VIMEO CONSENT]',...a);}catch(e){} };

    function hasMarketingConsent(){
      try {
        if (typeof Cookiebot !== 'undefined') {
          if (Cookiebot.consents && typeof Cookiebot.consents.marketing === 'boolean') return Cookiebot.consents.marketing;
          if (Cookiebot.consent  && typeof Cookiebot.consent.marketing  === 'boolean')  return Cookiebot.consent.marketing;
        }
        const cc = document.cookie.split('; ').find(r=>r.startsWith('CookieConsent='));
        return cc ? decodeURIComponent(cc.split('=')[1]).includes('marketing:true') : false;
      } catch(e){ return false; }
    }

    function grantMarketingAndPlay(){
      if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.submitCustomConsent === 'function') {
        // vorhandene Einstellungen übernehmen, Marketing einschalten
        const pref = !!(Cookiebot.consent?.preferences ?? Cookiebot.consents?.preferences);
        const stat = !!(Cookiebot.consent?.statistics  ?? Cookiebot.consents?.statistics);
        Cookiebot.submitCustomConsent(pref, stat, true);
      } else if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.renew === 'function') {
        // Fallback: Details öffnen
        Cookiebot.renew();
      }
      // Danach greifen unsere Events und spielen ab.
    }

    function isVimeoIframe(node){
      return node && node.tagName === 'IFRAME' && /(^|\/\/)(player\.)?vimeo\.com/i.test(node.src || '');
    }

    /* =================== Poster / UI =================== */
    function makePlaceholder(src, meta){
      const wrap = document.createElement('div');
      wrap.className = 'vimeo-consent-placeholder';
      wrap.setAttribute('data-vimeo-src', src);

      // Dimensionierung (aus meta)
      if (meta.widthAttr && meta.heightAttr) {
        wrap.style.aspectRatio = `${meta.widthAttr} / ${meta.heightAttr}`;
        wrap.style.width = /^\d+$/.test(meta.widthAttr) ? meta.widthAttr+'px' : meta.widthAttr;
      } else if (meta.cw && meta.ch) {
        wrap.style.aspectRatio = `${meta.cw} / ${meta.ch}`;
        wrap.style.width = meta.cw + 'px';
      } else {
        wrap.style.aspectRatio = FALLBACK_ASPECT;
        wrap.style.width = '100%';
      }

      // Poster + Button
      wrap.innerHTML = `
        <div class="vimeo-consent-poster">
          <img class="vimeo-consent-img" src="${DEFAULT_POSTER}" alt="Video-Placeholder" referrerpolicy="no-referrer">
          <button type="button" class="vimeo-consent-play">
            <svg aria-hidden="true" viewBox="0 0 68 48" class="vimeo-consent-icon"><path d="M66.52 7.74a8 8 0 0 0-11.3-2.96l-21.7 13.1a8 8 0 0 0 0 13.86l21.7 13.1a8 8 0 0 0 11.3-2.96A8 8 0 0 0 68 37.1V10.9a8 8 0 0 0-1.48-3.16z"></path></svg>
            <span>Marketing akzeptieren &amp; Video abspielen</span>
          </button>
        </div>
        <div class="vimeo-consent-note">Zum Abspielen bitte Marketing-Cookies zulassen.</div>
      `;

      // Klick → Einwilligung setzen & abspielen
      wrap.querySelector('.vimeo-consent-play').addEventListener('click', grantMarketingAndPlay);
      return wrap;
    }

    /* =================== Größen-Fix =================== */
    function snapshotIframeMeta(ifr){
      const rect = ifr.getBoundingClientRect();
      return {
        widthAttr:  ifr.getAttribute('width')  || '',
        heightAttr: ifr.getAttribute('height') || '',
        style:      ifr.getAttribute('style')  || '',
        className:  ifr.className || '',
        allow:      ifr.getAttribute('allow') || 'autoplay; fullscreen; picture-in-picture',
        allowFull:  ifr.hasAttribute('allowfullscreen') ? '1' : '',
        cw: Math.round(rect.width)  || '',
        ch: Math.round(rect.height) || ''
      };
    }

    /* =================== Block: Iframe -> Placeholder =================== */
    function replaceIframeWithPlaceholder(iframe){
      if (iframe.hasAttribute('data-consent-exempt')) return;
      const meta = snapshotIframeMeta(iframe);
      const src  = iframe.src;

      const ph = makePlaceholder(src, meta);
      // Original-Meta an Placeholder speichern
      Object.entries(meta).forEach(([k,v]) => ph.dataset[k] = v);

      iframe.parentNode.insertBefore(ph, iframe);
      iframe.parentNode.removeChild(iframe);
    }

    /* =================== Restore: Placeholder -> Iframe =================== */
    function withAutoplay(url){
      try {
        const u = new URL(url, location.origin);
        // Vimeo autoplay i.d.R. nur muted erlaubt
        if (!u.searchParams.has('autoplay')) u.searchParams.set('autoplay','1');
        if (!u.searchParams.has('muted'))    u.searchParams.set('muted','1');
        return u.toString();
      } catch(e){
        // Fallback für relative/protokoll-relative URLs
        const sep = url.includes('?') ? '&' : '?';
        return url + sep + 'autoplay=1&muted=1';
      }
    }

    function restoreVimeoFromPlaceholder(ph){
      const raw = ph.getAttribute('data-vimeo-src');
      if (!raw) return;
      const src = withAutoplay(raw);

      const f = document.createElement('iframe');
      f.src = src;

      // Ursprungs-Styles/Klassen/Attribute übernehmen
      const cls = ph.dataset.className || '';
      if (cls) f.className = cls;

      const style = ph.dataset.style || '';
      if (style) f.setAttribute('style', style);

      const w = ph.dataset.widthAttr || ph.dataset.cw || '';
      const h = ph.dataset.heightAttr || ph.dataset.ch || '';
      if (w && h) {
        f.setAttribute('width', String(w));
        f.setAttribute('height', String(h));
      } else {
        f.style.width = '100%';
        f.style.height = '100%';
      }

      f.setAttribute('frameborder','0');
      f.setAttribute('allow', ph.dataset.allow || 'autoplay; fullscreen; picture-in-picture');
      if (ph.dataset.allowFull) f.setAttribute('allowfullscreen','');

      const wrap = document.createElement('div');
      wrap.className = 'vimeo-consent-embed';
      wrap.style.width = ph.style.width || '100%';
      if (ph.style.aspectRatio) wrap.style.aspectRatio = ph.style.aspectRatio;

      wrap.appendChild(f);
      ph.parentNode.replaceChild(wrap, ph);
    }

    /* =================== Apply / Restore =================== */
    function blockAllVimeoIframes(ctx){
      const root = ctx || document;
      root.querySelectorAll('iframe[src*="vimeo.com"]').forEach(ifr=>{
        if (!hasMarketingConsent()) replaceIframeWithPlaceholder(ifr);
      });
    }

    function restoreAllPlaceholders(){
      if (!hasMarketingConsent()) return;
      document.querySelectorAll('.vimeo-consent-placeholder').forEach(restoreVimeoFromPlaceholder);
    }

    /* =================== Initial & Dynamik =================== */
    if (!hasMarketingConsent()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ()=> blockAllVimeoIframes(document));
      } else {
        blockAllVimeoIframes(document);
      }
    }

    new MutationObserver((ml)=>{
      const consent = hasMarketingConsent();
      for (const m of ml) for (const n of m.addedNodes) {
        if (n && n.tagName === 'IFRAME' && isVimeoIframe(n)) {
          if (!consent) replaceIframeWithPlaceholder(n);
        } else if (n && n.querySelectorAll) {
          if (!consent) {
            n.querySelectorAll('iframe[src*="vimeo.com"]').forEach(replaceIframeWithPlaceholder);
          }
        }
      }
    }).observe(document.documentElement, { childList:true, subtree:true });

    /* =================== State-Enforcer (Opt-in & Widerruf) =================== */
    function enforceVimeoConsentState(){
      if (hasMarketingConsent()) {
        restoreAllPlaceholders();
      } else {
        document.querySelectorAll('iframe[src*="vimeo.com"]').forEach(replaceIframeWithPlaceholder);
      }
    }
    window.addEventListener('CookiebotOnConsentReady', enforceVimeoConsentState);
    window.addEventListener('CookiebotOnAccept',      enforceVimeoConsentState);
    window.addEventListener('CookiebotOnDecline',     enforceVimeoConsentState);

    /* =================== Minimal-CSS =================== */
    const css = `
      .vimeo-consent-placeholder,
      .vimeo-consent-embed{ display:block; max-width:100%; }
      .vimeo-consent-embed{ position:relative; }
      .vimeo-consent-embed iframe{ width:100%; height:100%; display:block; }

      .vimeo-consent-placeholder{
        position:relative; overflow:hidden; background:#000; width:100%;
        border-radius:12px; margin:8px 0;
      }
      .vimeo-consent-poster{ position:relative; width:100%; height:100%; }
      .vimeo-consent-img{ width:100%; height:100%; object-fit:cover; display:block; }

      .vimeo-consent-play{
        position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
        display:flex; align-items:center; gap:.6rem;
        background:rgba(20,20,20,.9); color:#fff; border:0;
        padding:.8rem 1.1rem; border-radius:999px; cursor:pointer; font-weight:600;
        box-shadow:0 6px 20px rgba(0,0,0,.35);
      }
      .vimeo-consent-icon{ width:22px; height:22px; fill:#fff; }
      .vimeo-consent-note{
        position:absolute; left:12px; bottom:10px; right:12px;
        color:#fff; font-size:.85rem; text-shadow:0 1px 2px rgba(0,0,0,.6);
        pointer-events:none;
      }
    `;
    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
  })();
  </script>
{% endcomment %}

<!-- Block Vimeo End until Markting Consent (edit Michael Müller 9.9.25) -->

<!-- Block Typeform Start until Markting Consent (edit Michael Müller 9.9.25) -->

<script>
  (function () {
    /* ================= Helpers / Consent ================= */
    const log = (...a) => {
      try {
        console.debug('[TYPEFORM CONSENT]', ...a);
      } catch (e) {}
    };

    function hasMarketingConsent() {
      try {
        if (typeof Cookiebot !== 'undefined') {
          if (Cookiebot.consents && typeof Cookiebot.consents.marketing === 'boolean')
            return Cookiebot.consents.marketing;
          if (Cookiebot.consent && typeof Cookiebot.consent.marketing === 'boolean') return Cookiebot.consent.marketing;
        }
        // Fallback: CookieConsent-String (Cookiebot)
        const cc = document.cookie.split('; ').find((r) => r.startsWith('CookieConsent='));
        return cc ? decodeURIComponent(cc.split('=')[1]).includes('marketing:true') : false;
      } catch (e) {
        return false;
      }
    }

    /* ================= Erkennung Typeform ================= */
    // Typische Typeform-Quellen:
    // - iframes: https://form.typeform.com/to/...  oder https://typeform.com/to/...
    // - embed-scripts: https://embed.typeform.com/embed.js (u. a. popover/sidetab)
    function isTypeformIframe(node) {
      const src = node && node.tagName === 'IFRAME' ? node.src || '' : '';
      return /(^|\/\/)(form\.)?typeform\.com\/(to|forms)\//i.test(src);
    }
    function isTypeformScript(node) {
      const src = node && node.tagName === 'SCRIPT' ? node.src || '' : '';
      return /(^|\/\/)embed\.typeform\.com\/embed(\.js)?/i.test(src);
    }

    /* ================= Placeholder UI ================= */
    function makePlaceholder(src) {
      const wrap = document.createElement('div');
      wrap.className = 'typeform-consent-placeholder';
      wrap.setAttribute('data-typeform-src', src);
      wrap.innerHTML = `
      <div class="typeform-consent-box">
        <div class="typeform-consent-title">Formular blockiert</div>
        <div class="typeform-consent-text">Dieses Typeform wird erst nach Zustimmung zu Marketing-Cookies geladen.</div>
        <div class="typeform-consent-actions">
          <button type="button" class="typeform-consent-allow">Marketing akzeptieren & Formular laden</button>
          <button type="button" class="typeform-consent-settings">Einstellungen öffnen</button>
        </div>
      </div>
    `;
      const openDetails = () => {
        if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.renew === 'function') {
          Cookiebot.renew(); // direkt Detail-/Änderungsansicht
        } else if (typeof Cookiebot !== 'undefined' && typeof Cookiebot.show === 'function') {
          Cookiebot.show();
        } else {
          alert('Bitte Marketing-Cookies in den Cookie-Einstellungen aktivieren.');
        }
      };
      wrap.querySelector('.typeform-consent-allow').addEventListener('click', openDetails);
      wrap.querySelector('.typeform-consent-settings').addEventListener('click', openDetails);
      return wrap;
    }

    /* ================= Größen-Snapshot ================= */
    function snapshotIframeMeta(ifr) {
      const rect = ifr.getBoundingClientRect();
      return {
        widthAttr: ifr.getAttribute('width') || '',
        heightAttr: ifr.getAttribute('height') || '',
        style: ifr.getAttribute('style') || '',
        className: ifr.className || '',
        allow:
          ifr.getAttribute('allow') || 'camera; microphone; geolocation; clipboard-read; clipboard-write; autoplay',
        allowFull: ifr.hasAttribute('allowfullscreen') ? '1' : '',
        cw: Math.round(rect.width) || '',
        ch: Math.round(rect.height) || '',
      };
    }

    /* ================= Iframe -> Placeholder ================= */
    function replaceIframeWithPlaceholder(iframe) {
      if (iframe.hasAttribute('data-consent-exempt')) return; // Opt-out für einzelne iframes
      const meta = snapshotIframeMeta(iframe);
      const src = iframe.src;

      const ph = makePlaceholder(src);
      Object.entries(meta).forEach(([k, v]) => (ph.dataset[k] = v));

      // dimensionieren
      if (meta.widthAttr && meta.heightAttr) {
        ph.style.aspectRatio = `${meta.widthAttr} / ${meta.heightAttr}`;
        ph.style.width = /^\d+$/.test(meta.widthAttr) ? meta.widthAttr + 'px' : meta.widthAttr;
      } else if (meta.cw && meta.ch) {
        ph.style.aspectRatio = `${meta.cw} / ${meta.ch}`;
        ph.style.width = meta.cw + 'px';
      } else {
        ph.style.width = '100%';
        ph.style.aspectRatio = '3 / 4'; // Typeform ist oft höher – gern anpassen
      }

      iframe.parentNode.insertBefore(ph, iframe);
      iframe.parentNode.removeChild(iframe);
    }

    /* ================= Placeholder -> Iframe ================= */
    function restoreTypeformFromPlaceholder(ph) {
      const src = ph.getAttribute('data-typeform-src');
      if (!src) return;

      const f = document.createElement('iframe');
      f.src = src;

      // Ursprungs-Styles/Klassen/Attribute übernehmen
      const cls = ph.dataset.className || '';
      if (cls) f.className = cls;

      const style = ph.dataset.style || '';
      if (style) f.setAttribute('style', style);

      const w = ph.dataset.widthAttr || ph.dataset.cw || '';
      const h = ph.dataset.heightAttr || ph.dataset.ch || '';
      if (w && h) {
        f.setAttribute('width', String(w));
        f.setAttribute('height', String(h));
      } else {
        f.style.width = '100%';
        f.style.height = '100%';
      }

      f.setAttribute('frameborder', '0');
      f.setAttribute(
        'allow',
        ph.dataset.allow || 'camera; microphone; geolocation; clipboard-read; clipboard-write; autoplay'
      );
      if (ph.dataset.allowFull) f.setAttribute('allowfullscreen', '');

      const wrap = document.createElement('div');
      wrap.className = 'typeform-consent-embed';
      wrap.style.width = ph.style.width || '100%';
      if (ph.style.aspectRatio) wrap.style.aspectRatio = ph.style.aspectRatio;

      wrap.appendChild(f);
      ph.parentNode.replaceChild(wrap, ph);
    }

    /* ================= Skripte (embed.js) blocken / rehydrieren ================= */
    function markBlockedScript(node) {
      node.setAttribute('data-tf-blocked', '1');
      node.setAttribute('data-tf-src', node.src || '');
      try {
        node.removeAttribute('src');
      } catch (e) {}
      node.type = 'text/plain';
      log('blocked Typeform script', node.getAttribute('data-tf-src'));
    }

    async function restoreBlockedScripts() {
      if (!hasMarketingConsent()) return;
      const blocked = Array.from(document.querySelectorAll('script[data-tf-blocked="1"]'));
      for (const s of blocked) {
        const src = s.getAttribute('data-tf-src');
        if (!src) continue;
        await new Promise((res, rej) => {
          const el = document.createElement('script');
          el.src = src;
          el.async = true;
          el.onload = res;
          el.onerror = rej;
          document.head.appendChild(el);
        });
      }
    }

    /* ================= Sammelfunktionen ================= */
    function blockAllTypeform(context) {
      const root = context || document;
      // iframes
      root.querySelectorAll('iframe').forEach((ifr) => {
        if (!hasMarketingConsent() && isTypeformIframe(ifr)) replaceIframeWithPlaceholder(ifr);
      });
      // scripts
      root.querySelectorAll('script[src]').forEach((sc) => {
        if (!hasMarketingConsent() && isTypeformScript(sc)) markBlockedScript(sc);
      });
    }

    function restoreAllPlaceholders() {
      if (!hasMarketingConsent()) return;
      document.querySelectorAll('.typeform-consent-placeholder').forEach(restoreTypeformFromPlaceholder);
      restoreBlockedScripts();
    }

    /* ================= Initial & Dynamik ================= */
    // Initial
    if (!hasMarketingConsent()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => blockAllTypeform(document));
      } else {
        blockAllTypeform(document);
      }
    }

    // Dynamisch nachgeladen
    new MutationObserver((ml) => {
      const consent = hasMarketingConsent();
      for (const m of ml)
        for (const n of m.addedNodes) {
          if (n && n.tagName === 'IFRAME' && isTypeformIframe(n)) {
            if (!consent) replaceIframeWithPlaceholder(n);
          } else if (n && n.tagName === 'SCRIPT' && isTypeformScript(n)) {
            if (!consent) markBlockedScript(n);
          } else if (n && n.querySelectorAll) {
            if (!consent) {
              n.querySelectorAll('iframe').forEach((ifr) => isTypeformIframe(ifr) && replaceIframeWithPlaceholder(ifr));
              n.querySelectorAll('script[src]').forEach((sc) => isTypeformScript(sc) && markBlockedScript(sc));
            }
          }
        }
    }).observe(document.documentElement, { childList: true, subtree: true });

    /* ================= State-Enforcer (Opt-in & Widerruf) ================= */
    function enforceTypeformConsentState() {
      if (hasMarketingConsent()) {
        restoreAllPlaceholders();
      } else {
        // bei Widerruf: laufende Einbettungen wieder blocken
        document
          .querySelectorAll('iframe')
          .forEach((ifr) => isTypeformIframe(ifr) && replaceIframeWithPlaceholder(ifr));
      }
    }
    window.addEventListener('CookiebotOnConsentReady', enforceTypeformConsentState);
    window.addEventListener('CookiebotOnAccept', enforceTypeformConsentState);
    window.addEventListener('CookiebotOnDecline', enforceTypeformConsentState);

    /* ================= Minimal-CSS (optional ins Theme-CSS) ================= */
    const css = `
    .typeform-consent-placeholder,
    .typeform-consent-embed{ display:block; max-width:100%; }
    .typeform-consent-embed{ position:relative; }
    .typeform-consent-embed iframe{ width:100%; height:100%; display:block; }

    .typeform-consent-placeholder{
      border:1px solid #e5e5e5; background:#fafafa;
      padding:16px; text-align:center; margin:8px 0; width:100%;
    }
    .typeform-consent-title{ font-weight:600; margin-bottom:4px; }
    .typeform-consent-text{ font-size:14px; color:#444; margin-bottom:10px; }
    .typeform-consent-actions button{
      margin:0 4px; padding:8px 12px; cursor:pointer; border-radius:6px;
    }
    .typeform-consent-actions .typeform-consent-allow{
      background:#222; color:#fff; border:0;
    }
    .typeform-consent-actions .typeform-consent-settings{
      background:#fff; color:#222; border:1px solid #222;
    }
  `;
    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
  })();
</script>

<!-- Block Typeform End until Markting Consent (edit Michael Müller 9.9.25) -->
