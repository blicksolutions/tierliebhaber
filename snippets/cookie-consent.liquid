<script>
function feedback() {
  const p = window.Shopify.customerPrivacy;
  console.log(`Tracking ${p.userCanBeTracked() ? "en" : "dis"}abled`);
}

window.Shopify.loadFeatures([{
  name: "consent-tracking-api",
  version: "0.1",
}], function (error) {
  if (error) throw error;
  
  if ("Cookiebot" in window) {
    window.Shopify.customerPrivacy.setTrackingConsent({
      "analytics": false,
      "marketing": false,
      "preferences": false,
      "sale_of_data": false,
    }, () => console.log("Awaiting consent"));
  }
});

window.addEventListener("CookiebotOnConsentReady", function () {
  const C = Cookiebot.consent;
  
  const existConsentShopify = setInterval(function () {
    if (window.Shopify.customerPrivacy) {
      clearInterval(existConsentShopify);
      
      window.Shopify.customerPrivacy.setTrackingConsent({
        "analytics": C["statistics"] && C["necessary"],
        "marketing": C["marketing"] && C["necessary"],
        "preferences": C["preferences"] && C["necessary"],
        "sale_of_data": C["marketing"] && C["necessary"],
      }, () => {
        console.log("Consent captured");
        // Trigger custom event for other scripts
        window.dispatchEvent(new CustomEvent('gdprConsentUpdated', {
          detail: { consent: C }
        }));
      });
    }
  }, 100);
});

// Handle consent changes (withdrawal)
window.addEventListener("CookiebotOnConsentChanged", function () {
  location.reload(); // Reload page when consent changes
});
</script>