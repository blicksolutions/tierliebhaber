/* ================= Reviews.io Consent Gate (Display + Tracking Split) ============== */

(function(){
  'use strict';
  if (window.__REVIEWSIO_CONSENT_GATE_LOADED__) return;
  window.__REVIEWSIO_CONSENT_GATE_LOADED__ = true;

  var BLOCKED_HOSTS = [
    "widget.reviews.io","api.reviews.io","cdn.reviews.io","media.reviews.io","widgets.reviews.co.uk"
  ];
  
  // Scripts für ANZEIGE (ohne Consent)
  var DISPLAY_SCRIPTS = [
    "https://widget.reviews.io/polaris/build.js",
    "https://widget.reviews.io/rating-snippet/dist.js"
  ];
  
  // URLs die TRACKING enthalten (brauchen Consent)
  var TRACKING_PATTERNS = [
    '/track',
    '/analytics',
    '/pixel',
    '/collect',
    '/event'
  ];

  function hasCookiebot(){ return !!(window.Cookiebot && window.Cookiebot.consent); }
  function marketingOn(){
    try{
      if (!hasCookiebot()) return false;
      return window.Cookiebot.consent.marketing === true;
    }catch(e){ return false; }
  }
  
  function isBlockedUrl(url){
    if (!url) return false;
    try{
      var urlStr = url.toString ? url.toString() : String(url);
      var u = new URL(urlStr, location.href);
      var h = u.hostname;
      return BLOCKED_HOSTS.some(function(b){ return h === b || h.endsWith("." + b); });
    }catch(e){ return false; }
  }
  
  // NEU: Prüft ob URL Tracking enthält
  function isTrackingUrl(url){
    if (!url) return false;
    try{
      var urlStr = url.toString ? url.toString() : String(url);
      return TRACKING_PATTERNS.some(function(pattern){ 
        return urlStr.toLowerCase().includes(pattern); 
      });
    }catch(e){ return false; }
  }

  var __loaded = new Set();
  var __loading = new Map();

  function loadScript(src){
    if (!src) return Promise.resolve();
    if (__loaded.has(src)) return Promise.resolve(src);
    if (__loading.has(src)) return __loading.get(src);

    var p = new Promise(function(res, rej){
      try {
        var s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = function(){
          __loaded.add(src);
          __loading.delete(src);
          res(src);
        };
        s.onerror = function(){
          __loading.delete(src);
          rej(new Error("Script load failed: " + src));
        };
        document.head.appendChild(s);
      } catch(e) {
        rej(e);
      }
    });
    __loading.set(src, p);
    return p;
  }

  function waitFor(fn, timeout){
    var t0 = Date.now();
    return new Promise(function(resolve){
      (function tick(){
        try{
          var v = fn();
          if (v) { resolve(v); return; }
        }catch(e){}
        if (Date.now() - t0 > (timeout || 6000)) {
          resolve(null);
          return;
        }
        setTimeout(tick, 100);
      })();
    });
  }

  /* ----- Stubs ----- */
  var __rsCalls = [];
  var __rsStub = function(selector, options){
    __rsCalls.push({ selector: selector, options: options });
    return {};
  };
  
  if (typeof window.ratingSnippet !== "function") {
    window.ratingSnippet = __rsStub;
  }

  var __rwCalls = [];
  var __rwStub = function(action, data){
    __rwCalls.push({ action: action, data: data });
    return {};
  };
  
  if (typeof window.ReviewsWidget !== "function") {
    window.ReviewsWidget = __rwStub;
  }

  var blockedScriptQueue = [];
  function queue(src){
    if (src && !blockedScriptQueue.includes(src)) {
      blockedScriptQueue.push(src);
    }
  }

  /* ----- Patch XHR (NUR Tracking blockieren) ----- */
  (function(){
    var open = XMLHttpRequest.prototype.open;
    if (!XMLHttpRequest.prototype.__reviewsioPatched) {
      XMLHttpRequest.prototype.__reviewsioPatched = true;
      XMLHttpRequest.prototype.open = function(m, u){
        try {
          // Blockiere NUR Tracking-Requests ohne Consent
          if (!marketingOn() && isBlockedUrl(u) && isTrackingUrl(u)) return;
        } catch(e) {}
        return open.apply(this, arguments);
      };
    }
  })();

  /* ----- Patch fetch (NUR Tracking blockieren) ----- */
  (function(){
    var _f = window.fetch;
    if (!_f.__reviewsioPatched) {
      window.fetch = function(r, i){
        try {
          var u = (typeof r === "string") ? r : (r && r.url);
          // Blockiere NUR Tracking-Requests ohne Consent
          if (!marketingOn() && u && isBlockedUrl(u) && isTrackingUrl(u)) {
            return Promise.reject(new TypeError("Blocked by consent gate"));
          }
        } catch(e) {}
        return _f.apply(this, arguments);
      };
      window.fetch.__reviewsioPatched = true;
    }
  })();

  /* ----- DOM Blocker (NUR Tracking-Scripts blockieren) ----- */
  function patchElementMethod(name){
    var orig = Element.prototype[name];
    if (!orig || orig.__reviewsioPatched) return;
    
    function wrapped(child){
      var shouldBlock = false;
      var src = null;
      
      try{
        if (child && child.tagName) {
          var t = child.tagName.toLowerCase();
          src = child.src || (child.getAttribute && child.getAttribute("src"));
          
          if (t === "script" && src && __loaded.has(src)) return child;
          
          // Blockiere NUR wenn es ein Tracking-Script ist UND kein Consent
          if ((t === "script" || t === "iframe") && src && !marketingOn() && isBlockedUrl(src) && isTrackingUrl(src)) {
            if (t === "script") queue(src);
            shouldBlock = true;
          }
        }
      }catch(e){}
      
      if (shouldBlock) return child;
      return orig.call(this, child);
    }
    wrapped.__reviewsioPatched = true;
    Element.prototype[name] = wrapped;
  }
  
  patchElementMethod("appendChild");
  patchElementMethod("insertBefore");

  /* ----- MutationObserver (NUR Tracking blockieren) ----- */
  var mo = new MutationObserver(function(muts){
    if (marketingOn()) return;
    muts.forEach(function(m){
      if (!m.addedNodes) return;
      m.addedNodes.forEach(function(n){
        try{
          if (n && n.tagName) {
            var t = n.tagName.toLowerCase();
            var src = n.src || (n.getAttribute && n.getAttribute('src'));
            // Blockiere NUR Tracking-Scripts
            if ((t === 'script' || t === 'iframe') && src && isBlockedUrl(src) && isTrackingUrl(src)) {
              if (t === 'script') queue(src);
              n.remove();
            }
          }
        }catch(e){}
      });
    });
  });
  
  try {
    mo.observe(document.documentElement, {childList: true, subtree: true});
  } catch(e) {}

  /* ----- Auto-Init + Replay ----- */
  function autoInit(){
    try{
      if (window.rio && typeof window.rio === "function") {
        try{ window.rio("init"); }catch(e){}
      }
      if (window.rio && typeof window.rio.init === "function") {
        try{ window.rio.init({}); }catch(e){}
      }

      if (window.RatingSnippet && typeof window.RatingSnippet.init === "function") {
        try{ window.RatingSnippet.init(); }catch(e){}
      }

      if (typeof window.ratingSnippet === "function" && window.ratingSnippet !== __rsStub) {
        __rsCalls.forEach(function(call){
          try{
            window.ratingSnippet(call.selector, call.options);
          }catch(e){}
        });
        __rsCalls.length = 0;
      }

      if (typeof window.ReviewsWidget === "function" && window.ReviewsWidget !== __rwStub) {
        __rwCalls.forEach(function(call){
          try{
            window.ReviewsWidget(call.action, call.data);
          }catch(e){}
        });
        __rwCalls.length = 0;
      }

      try {
        document.dispatchEvent(new CustomEvent("reviewsio:consent-granted"));
      } catch(e) {}
    }catch(e){}
  }

  /* ----- Display-Scripts IMMER laden (ohne Consent) ----- */
  var displayLoaded = false;
  
  function loadDisplayScripts(){
    if (displayLoaded) return;
    displayLoaded = true;
    
    (async function(){
      try{
        for (var i = 0; i < DISPLAY_SCRIPTS.length; i++) {
          try {
            await loadScript(DISPLAY_SCRIPTS[i]);
          } catch(e) {}
        }
        
        await waitFor(function(){
          try {
            return (typeof window.ratingSnippet === "function" && window.ratingSnippet !== __rsStub) ||
                   window.RatingSnippet ||
                   window.rio ||
                   window.REVIEWSIO;
          } catch(e) {
            return false;
          }
        }, 6000);
        
        autoInit();
      }catch(e){}
    })();
  }

  /* ----- Tracking-Scripts MIT Consent laden ----- */
  var trackingEnabled = false;
  
  function enableTracking(){
    if (trackingEnabled) return;
    if (!marketingOn()) return;
    
    trackingEnabled = true;
    
    (async function(){
      try{
        var toLoad = blockedScriptQueue.length ? blockedScriptQueue.slice() : [];
        blockedScriptQueue.length = 0;
        
        for (var j = 0; j < toLoad.length; j++) {
          try {
            await loadScript(toLoad[j]);
          } catch(e) {}
        }
        
        if (mo && typeof mo.disconnect === "function") {
          try {
            mo.disconnect();
          } catch(e) {}
        }
      }catch(err){}
    })();
  }

  /* ----- Event Listeners ----- */
  function on(evt, fn){ 
    try {
      window.addEventListener(evt, fn, false);
    } catch(e) {}
  }

  // Display-Scripts SOFORT laden (ohne Consent)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadDisplayScripts);
  } else {
    loadDisplayScripts();
  }
  
  // Tracking MIT Consent
  if (marketingOn()) enableTracking();
  on("CookiebotOnLoad", enableTracking);
  on("CookiebotOnConsentReady", enableTracking);
  on("CookiebotOnAccept", enableTracking);
  
  try {
    window.addEventListener("load", function(){
      if (marketingOn()) enableTracking();
    });
  } catch(e) {}
})();