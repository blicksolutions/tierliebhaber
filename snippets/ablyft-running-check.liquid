{% comment %}
==============================================================================
ABlyft A/B-Testing - OPTIMIERT
==============================================================================
{% endcomment %}

{% comment %} Preconnect {% endcomment %}
<link rel="preconnect" href="https://cdn.ablyft.com">

{% comment %} Intelligenter Anti-Flicker - NUR wenn Consent existiert {% endcomment %}
<script>
(function() {
  // Check: Hat User bereits Marketing-Consent?
  var hasMarketingConsent = document.cookie.match(/CookieConsent=[^;]*marketing:true/i);
  var isAfterReload = sessionStorage.getItem('ablyft_reload_done');
  
  // Anti-Flicker NUR wenn Consent existiert oder nach Reload
  if (hasMarketingConsent || isAfterReload) {
    console.log('[ABlyft] Anti-flicker ACTIVE (consent exists)');
    
    // Füge Anti-Flicker Style ein
    var style = document.createElement('style');
    style.id = 'ablyft-anti-flicker';
    style.textContent = 'body { opacity: 0 !important; transition: opacity 0.2s ease-in; }';
    document.head.appendChild(style);
    
    // Timeout Fallback
    var timeout = setTimeout(function() {
      var style = document.getElementById('ablyft-anti-flicker');
      if (style && style.parentNode) {
        style.parentNode.removeChild(style);
      }
      document.body.style.opacity = '1';
      console.log('[ABlyft] Anti-flicker timeout reached');
    }, 2000);
    
    // Show Body Funktion
    window.ablyftShowBody = function() {
      clearTimeout(timeout);
      var style = document.getElementById('ablyft-anti-flicker');
      if (style && style.parentNode) {
        style.parentNode.removeChild(style);
      }
      document.body.style.opacity = '1';
      console.log('[ABlyft] Body shown');
    };
    
  } else {
    console.log('[ABlyft] Anti-flicker INACTIVE (no consent yet)');
    
    // Kein Anti-Flicker, Body ist direkt sichtbar
    window.ablyftShowBody = function() {
      console.log('[ABlyft] Body already visible (no anti-flicker)');
    };
  }
})();
</script>

{% comment %} ABlyft Core Script {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing" async src="https://cdn.ablyft.com/s/55886406.js"></script>

{% comment %} ABlyft Consent Detection {% endcomment %}
<script>
(function() {
  'use strict';
  
  window._ablyftConsentChanged = false;
  
  // Check ob Banner angezeigt wird
  function checkBannerShown() {
    return new Promise(function(resolve) {
      var checks = 0;
      var interval = setInterval(function() {
        checks++;
        
        var banner = document.querySelector('#CybotCookiebotDialog');
        if (banner && banner.offsetParent !== null) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'true');
          resolve(true);
          return;
        }
        
        if (window.Cookiebot && window.Cookiebot.hasResponse === false) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'true');
          resolve(true);
          return;
        }
        
        if (checks >= 20) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'false');
          resolve(false);
        }
      }, 100);
    });
  }
  
  // Event Handler
  window.addEventListener('CookiebotOnAccept', function() {
    var bannerWasShown = sessionStorage.getItem('ablyft_banner_shown') === 'true';
    
    if (bannerWasShown) {
      window._ablyftConsentChanged = true;
      sessionStorage.setItem('ablyft_consent_changed', Date.now());
      sessionStorage.removeItem('ablyft_banner_shown');
    }
  }, false);
  
  // Start Check
  checkBannerShown();
  
})();
</script>

{% comment %} ABlyft Reload & Wait Logic {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing">
(function() {
  'use strict';
  
  window['ablyft'] = window['ablyft'] || [];
  
  const CONFIG = {
    sessionKey: 'ablyft_reload_done',
    maxWaitTime: 500,    // Max 500ms auf ABlyft warten
    checkInterval: 50,
    debug: false  // Auf FALSE für Production!
  };
  
  function log(message) {
    if (CONFIG.debug) {
      console.log('[ABlyft]', message);
    }
  }
  
  // Check ob ABlyft fertig ist
  function isAblyftReady() {
    if (document.cookie.match(/ablyft_exps=([^;]+)/)) {
      return true;
    }
    if (window.ablyft && (window.ablyft._ready || window.ablyft._initialized)) {
      return true;
    }
    return false;
  }
  
  // Warte auf ABlyft
  function waitForAblyft() {
    return new Promise(function(resolve) {
      var startTime = Date.now();
      var interval = setInterval(function() {
        var elapsed = Date.now() - startTime;
        
        if (isAblyftReady()) {
          clearInterval(interval);
          log('ABlyft ready after ' + elapsed + 'ms');
          resolve(true);
          return;
        }
        
        if (elapsed >= CONFIG.maxWaitTime) {
          clearInterval(interval);
          log('Timeout after ' + elapsed + 'ms');
          resolve(false);
        }
      }, CONFIG.checkInterval);
    });
  }
  
  // Main Init
  function init() {
    // Check: Bereits reloaded?
    var reloadDone = sessionStorage.getItem(CONFIG.sessionKey);
    
    if (reloadDone) {
      log('Already reloaded - showing body');
      waitForAblyft().then(function() {
        if (window.ablyftShowBody) {
          window.ablyftShowBody();
        }
      });
      return;
    }
    
    // Check: Neuer Consent?
    var consentWasChanged = window._ablyftConsentChanged === true ||
                            sessionStorage.getItem('ablyft_consent_changed');
    
    try {
      sessionStorage.removeItem('ablyft_consent_changed');
    } catch(e) {}
    
    if (consentWasChanged) {
      log('New consent - waiting for ABlyft, then reload');
      
      // Warte bis ABlyft DOM manipuliert hat
      waitForAblyft().then(function() {
        log('ABlyft ready - triggering reload for proper initialization');
        
        // Setze Flag
        try {
          sessionStorage.setItem(CONFIG.sessionKey, Date.now());
        } catch(e) {}
        
        // Reload
        setTimeout(function() {
          window.location.reload();
        }, 100);
      });
      
    } else {
      log('Existing consent - ABlyft already loaded correctly');
      if (window.ablyftShowBody) {
        window.ablyftShowBody();
      }
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>