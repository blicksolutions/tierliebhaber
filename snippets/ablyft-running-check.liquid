<!-- ABlyft Pre-Consent Detection -->
<script>
(function() {
  console.log('[Diagnose] Pre-Consent script loaded');
  
  window._ablyftConsentChanged = false;
  
  window.addEventListener('CookiebotOnAccept', function(e) {
    console.log('[Diagnose] Consent given!');
    
    var bannerWasShown = !sessionStorage.getItem('ablyft_had_consent');
    
    if (bannerWasShown) {
      console.log('[Diagnose] NEW consent detected');
      window._ablyftConsentChanged = true;
      sessionStorage.setItem('ablyft_consent_changed', 'true');
      sessionStorage.setItem('ablyft_had_consent', 'true');
    } else {
      console.log('[Diagnose] Existing consent (reload)');
      window._ablyftConsentChanged = false;
    }
  });
})();
</script>

<!-- ABlyft Core Script -->
<script type="text/plain" data-cookieconsent="marketing" async src="https://cdn.ablyft.com/s/55886406.js"></script>

<!-- Diagnose Main Script -->
<script type="text/plain" data-cookieconsent="marketing">
(function() {
  console.log('[Diagnose] Main script loaded AFTER consent');
  
  // Snapshot BEFORE ABlyft does anything
  var initialDOM = document.body.innerHTML.length;
  var initialCookie = document.cookie;
  
  console.log('[Diagnose] Initial DOM length:', initialDOM);
  console.log('[Diagnose] Initial cookies:', initialCookie);
  
  // Wait and observe what ABlyft does
  var checkCount = 0;
  var maxChecks = 50; // 5 seconds
  
  var observer = setInterval(function() {
    checkCount++;
    
    // Check for changes
    var currentDOM = document.body.innerHTML.length;
    var currentCookie = document.cookie;
    var ablyftCookie = document.cookie.match(/ablyft_exps=([^;]+)/);
    
    // Did ABlyft change anything?
    if (currentDOM !== initialDOM) {
      console.log('[Diagnose] ‚úÖ DOM CHANGED after ' + (checkCount * 100) + 'ms');
      console.log('[Diagnose] DOM grew by:', currentDOM - initialDOM, 'characters');
      clearInterval(observer);
      diagnoseComplete('dom_manipulation');
      return;
    }
    
    if (ablyftCookie) {
      console.log('[Diagnose] ‚úÖ ABLYFT COOKIE SET after ' + (checkCount * 100) + 'ms');
      console.log('[Diagnose] Cookie value:', decodeURIComponent(ablyftCookie[1]));
      clearInterval(observer);
      diagnoseComplete('cookie_set');
      return;
    }
    
    // Check if ABlyft initialized
    if (window.ablyft && (window.ablyft._ready || window.ablyft._initialized)) {
      console.log('[Diagnose] ‚úÖ ABLYFT INITIALIZED after ' + (checkCount * 100) + 'ms');
      console.log('[Diagnose] window.ablyft:', window.ablyft);
      clearInterval(observer);
      diagnoseComplete('initialized');
      return;
    }
    
    // Timeout
    if (checkCount >= maxChecks) {
      console.log('[Diagnose] ‚è±Ô∏è TIMEOUT - ABlyft did nothing in 5 seconds');
      clearInterval(observer);
      diagnoseComplete('timeout');
    }
    
  }, 100);
  
  // Also monitor for reload
  var originalReload = window.location.reload;
  window.location.reload = function() {
    console.log('[Diagnose] üîÑ RELOAD TRIGGERED!');
    console.log('[Diagnose] Stack trace:', new Error().stack);
    clearInterval(observer);
    originalReload.call(window.location);
  };
  
  function diagnoseComplete(result) {
    console.log('=================================');
    console.log('[Diagnose] RESULT:', result);
    console.log('=================================');
    
    switch(result) {
      case 'dom_manipulation':
        console.log('‚úÖ ABlyft manipulates DOM without reload');
        console.log('‚Üí Solution: Wait for ABlyft, then show body (NO reload needed)');
        break;
        
      case 'cookie_set':
        console.log('‚úÖ ABlyft sets cookie');
        console.log('‚Üí Check if DOM also changed or if reload is needed');
        break;
        
      case 'initialized':
        console.log('‚úÖ ABlyft initialized');
        console.log('‚Üí Check if tests are actually running');
        break;
        
      case 'timeout':
        console.log('‚ùå ABlyft did NOTHING');
        console.log('‚Üí Solution: WE must trigger reload for tests to work');
        console.log('‚Üí Use: sessionStorage flag + location.reload()');
        break;
    }
    
    // Show current state
    console.log('');
    console.log('Current state:');
    console.log('- window.ablyft:', window.ablyft);
    console.log('- ABlyft cookie:', document.cookie.match(/ablyft_exps=([^;]+)/));
    console.log('- DOM elements with [data-ablyft]:', document.querySelectorAll('[data-ablyft]').length);
    
    // Show body after diagnosis
    if (window.ablyftShowBody) {
      console.log('[Diagnose] Showing body now');
      window.ablyftShowBody();
    }
  }
  
})();
</script>