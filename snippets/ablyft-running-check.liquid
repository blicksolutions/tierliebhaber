{% comment %}
==============================================================================
ABlyft A/B-Testing - OPTIMIERT
==============================================================================
{% endcomment %}

{% comment %} Preconnect {% endcomment %}
<link rel="preconnect" href="https://cdn.ablyft.com">

{% comment %} Intelligenter Anti-Flicker - NUR wenn Consent existiert {% endcomment %}
<script>
(function() {
  // Check: Hat User bereits Marketing-Consent?
  var hasMarketingConsent = document.cookie.match(/CookieConsent=[^;]*marketing:true/i);
  var isAfterReload = sessionStorage.getItem('ablyft_reload_done');
  
  // Anti-Flicker NUR wenn Consent existiert oder nach Reload
  if (hasMarketingConsent || isAfterReload) {
    console.log('[ABlyft] Anti-flicker ACTIVE (consent exists)');
    
    // Füge Anti-Flicker Style ein
    var style = document.createElement('style');
    style.id = 'ablyft-anti-flicker';
    style.textContent = 'body { opacity: 0 !important; transition: opacity 0.2s ease-in; }';
    document.head.appendChild(style);
    
    // Timeout Fallback
    var timeout = setTimeout(function() {
      var style = document.getElementById('ablyft-anti-flicker');
      if (style && style.parentNode) {
        style.parentNode.removeChild(style);
      }
      document.body.style.opacity = '1';
      console.log('[ABlyft] Anti-flicker timeout reached');
    }, 2000);
    
    // Show Body Funktion
    window.ablyftShowBody = function() {
      clearTimeout(timeout);
      var style = document.getElementById('ablyft-anti-flicker');
      if (style && style.parentNode) {
        style.parentNode.removeChild(style);
      }
      document.body.style.opacity = '1';
      console.log('[ABlyft] Body shown');
    };
    
  } else {
    console.log('[ABlyft] Anti-flicker INACTIVE (no consent yet)');
    
    // Kein Anti-Flicker, Body ist direkt sichtbar
    window.ablyftShowBody = function() {
      console.log('[ABlyft] Body already visible (no anti-flicker)');
    };
  }
})();
</script>

{% comment %} ABlyft Core Script {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing" async src="https://cdn.ablyft.com/s/55886406.js"></script>

{% comment %} ABlyft Consent Detection {% endcomment %}
<script>
(function() {
  'use strict';
  
  window._ablyftConsentChanged = false;
  
  // Check ob Banner angezeigt wird
  function checkBannerShown() {
    return new Promise(function(resolve) {
      var checks = 0;
      var interval = setInterval(function() {
        checks++;
        
        var banner = document.querySelector('#CybotCookiebotDialog');
        if (banner && banner.offsetParent !== null) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'true');
          resolve(true);
          return;
        }
        
        if (window.Cookiebot && window.Cookiebot.hasResponse === false) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'true');
          resolve(true);
          return;
        }
        
        if (checks >= 20) {
          clearInterval(interval);
          sessionStorage.setItem('ablyft_banner_shown', 'false');
          resolve(false);
        }
      }, 100);
    });
  }
  
  // Event Handler
  window.addEventListener('CookiebotOnAccept', function() {
    var bannerWasShown = sessionStorage.getItem('ablyft_banner_shown') === 'true';
    
    if (bannerWasShown) {
      window._ablyftConsentChanged = true;
      sessionStorage.setItem('ablyft_consent_changed', Date.now());
      sessionStorage.removeItem('ablyft_banner_shown');
    }
  }, false);
  
  // Start Check
  checkBannerShown();
  
})();
</script>

{% comment %} ABlyft Wait & Show - KEIN Reload {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing">
(function() {
  'use strict';
  
  window['ablyft'] = window['ablyft'] || [];
  
  const CONFIG = {
    maxWaitTime: 200,    // Max 500ms auf ABlyft warten
    checkInterval: 50,
    debug: false  // Auf FALSE für Production!
  };
  
  function log(message) {
    if (CONFIG.debug) {
      console.log('[ABlyft]', message);
    }
  }
  
  // Check ob ABlyft fertig ist
  function isAblyftReady() {
    // Check 1: Cookie gesetzt?
    if (document.cookie.match(/ablyft_exps=([^;]+)/)) {
      return true;
    }
    
    // Check 2: Window Object initialisiert?
    if (window.ablyft && (
        window.ablyft._ready ||
        window.ablyft._initialized ||
        window.ablyft.experiments
    )) {
      return true;
    }
    
    return false;
  }
  
  // Warte auf ABlyft
  function waitForAblyft() {
    return new Promise(function(resolve) {
      var startTime = Date.now();
      
      var interval = setInterval(function() {
        var elapsed = Date.now() - startTime;
        
        if (isAblyftReady()) {
          clearInterval(interval);
          log('ABlyft ready after ' + elapsed + 'ms');
          resolve(true);
          return;
        }
        
        if (elapsed >= CONFIG.maxWaitTime) {
          clearInterval(interval);
          log('Timeout after ' + elapsed + 'ms');
          resolve(false);
        }
      }, CONFIG.checkInterval);
    });
  }
  
  // Main Init
  function init() {
    log('Initializing...');
    
    // Check: Neuer Consent?
    var consentWasChanged = window._ablyftConsentChanged === true ||
                            sessionStorage.getItem('ablyft_consent_changed');
    
    // Lösche Flag
    try {
      sessionStorage.removeItem('ablyft_consent_changed');
    } catch(e) {}
    
    if (consentWasChanged) {
      log('New consent - waiting for ABlyft to manipulate DOM...');
      
      // Warte bis ABlyft DOM manipuliert hat
      waitForAblyft().then(function(ready) {
        if (ready) {
          log('ABlyft finished DOM manipulation - showing page');
        } else {
          log('ABlyft timeout - showing page anyway');
        }
        
        // ✅ WICHTIG: NUR Body zeigen, KEIN Reload!
        if (window.ablyftShowBody) {
          window.ablyftShowBody();
        }
      });
      
    } else {
      log('Existing consent - showing page immediately');
      
      // Zeige Body sofort
      if (window.ablyftShowBody) {
        window.ablyftShowBody();
      }
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
})();
</script>

{% comment %} ABlyft Performance Optimizer - Global {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing">
(function() {
  'use strict';
  
  const CONFIG = {
    debug: false,
    lazyLoadThreshold: 200,  // Pixel below viewport
  };
  
  function log(message) {
    if (CONFIG.debug) {
      console.log('[ABlyft Optimizer]', message);
    }
  }
  
  // Warte bis ABlyft DOM manipuliert hat
  function waitForAblyftImages() {
    return new Promise(function(resolve) {
      var attempts = 0;
      var maxAttempts = 20;
      
      var interval = setInterval(function() {
        attempts++;
        
        // Check ob ABlyft Bilder geladen wurden
        var ablyftImages = document.querySelectorAll('img[src*="assets.ablyft.com"]');
        
        if (ablyftImages.length > 0) {
          clearInterval(interval);
          log('Found ' + ablyftImages.length + ' ABlyft images');
          resolve(ablyftImages);
          return;
        }
        
        if (attempts >= maxAttempts) {
          clearInterval(interval);
          log('No ABlyft images found');
          resolve([]);
        }
      }, 100);
    });
  }
  
  // Check ob Bild im Viewport ist
  function isInViewport(element, threshold) {
    var rect = element.getBoundingClientRect();
    var windowHeight = window.innerHeight || document.documentElement.clientHeight;
    
    // Ist Bild above the fold + threshold?
    return rect.top <= (windowHeight + threshold);
  }
  
  // Aktiviere Lazy Loading für Bilder below the fold
  function optimizeImages(images) {
    var optimizedCount = 0;
    var immediateCount = 0;
    
    Array.from(images).forEach(function(img) {
      
      // Skip wenn bereits geladen
      if (img.complete) {
        return;
      }
      
      // Check ob below the fold
      if (!isInViewport(img, CONFIG.lazyLoadThreshold)) {
        
        // Speichere Original-Src
        var originalSrc = img.src;
        
        // Setze data-src und entferne src
        img.setAttribute('data-ablyft-lazy', originalSrc);
        img.removeAttribute('src');
        
        // Füge native Lazy Loading hinzu
        img.loading = 'lazy';
        
        optimizedCount++;
        log('Lazy loading enabled for image: ' + originalSrc.substring(0, 50) + '...');
        
      } else {
        immediateCount++;
      }
    });
    
    log('Optimization complete:');
    log('- Images loading immediately: ' + immediateCount);
    log('- Images with lazy loading: ' + optimizedCount);
    
    // Starte Lazy Loading
    if (optimizedCount > 0) {
      enableLazyLoading();
    }
  }
  
  // Intersection Observer für Lazy Loading
  function enableLazyLoading() {
    // Check Browser Support
    if (!('IntersectionObserver' in window)) {
      log('IntersectionObserver not supported - loading all images');
      loadAllLazyImages();
      return;
    }
    
    var lazyImages = document.querySelectorAll('img[data-ablyft-lazy]');
    
    var imageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          var lazySrc = img.getAttribute('data-ablyft-lazy');
          
          if (lazySrc) {
            img.src = lazySrc;
            img.removeAttribute('data-ablyft-lazy');
            observer.unobserve(img);
            log('Lazy loaded: ' + lazySrc.substring(0, 50) + '...');
          }
        }
      });
    }, {
      rootMargin: CONFIG.lazyLoadThreshold + 'px'
    });
    
    lazyImages.forEach(function(img) {
      imageObserver.observe(img);
    });
    
    log('Intersection Observer active for ' + lazyImages.length + ' images');
  }
  
  // Fallback: Lade alle Bilder (für alte Browser)
  function loadAllLazyImages() {
    var lazyImages = document.querySelectorAll('img[data-ablyft-lazy]');
    
    lazyImages.forEach(function(img) {
      var lazySrc = img.getAttribute('data-ablyft-lazy');
      if (lazySrc) {
        img.src = lazySrc;
        img.removeAttribute('data-ablyft-lazy');
      }
    });
  }
  
  // Start Optimization
  function init() {
    log('Starting optimization...');
    
    waitForAblyftImages().then(function(images) {
      if (images.length > 0) {
        optimizeImages(images);
      } else {
        log('No ABlyft images to optimize');
      }
    });
  }
  
  // Warte kurz damit ABlyft Zeit hat DOM zu manipulieren
  setTimeout(init, 300);
  
})();
</script>