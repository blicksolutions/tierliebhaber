{% comment %}
  ==============================================================================
  ABlyft A/B-Testing - CORE SCRIPT
  ==============================================================================
  WICHTIG: Im <head> laden um FOOC (Flash of Original Content) zu vermeiden
  Zweck: Variantenauslieferung MUSS vor DOM-Rendering passieren
  ==============================================================================
{% endcomment %}

<!-- Preconnect zu ABlyft -->
<link rel="preconnect" href="https://cdn.ablyft.com">

<!-- Anti-Flicker Snippet -->
<style id="ablyft-anti-flicker">
  body { opacity: 0 !important; }
</style>
<script>
  window.ablyftShowBody = function () {
    document.body.style.opacity = '1';
    var style = document.getElementById('ablyft-anti-flicker');
    if (style && style.parentNode) {
      style.parentNode.removeChild(style);
    }
  };
  setTimeout(function () {
    if (document.body.style.opacity === '0') {
      window.ablyftShowBody();
    }
  }, 2000);
</script>

{% comment %} ABlyft Consent Detection {% endcomment %}
<script>
  (function () {
    'use strict';

    // Flag ob Consent NEU gegeben wurde
    window._ablyftConsentChanged = false;

    // Markiere ob Banner angezeigt wurde
    function checkIfBannerShown() {
      return new Promise(function (resolve) {
        var checks = 0;
        var interval = setInterval(function () {
          checks++;

          // Check: Banner sichtbar?
          var banner = document.querySelector('#CybotCookiebotDialog');
          if (banner && banner.offsetParent !== null) {
            clearInterval(interval);
            sessionStorage.setItem('ablyft_banner_shown', 'true');
            resolve(true);
            return;
          }

          // Check: Cookiebot sagt "kein Response"?
          if (window.Cookiebot && window.Cookiebot.hasResponse === false) {
            clearInterval(interval);
            sessionStorage.setItem('ablyft_banner_shown', 'true');
            resolve(true);
            return;
          }

          // Timeout: Kein Banner
          if (checks >= 20) {
            clearInterval(interval);
            sessionStorage.setItem('ablyft_banner_shown', 'false');
            resolve(false);
          }
        }, 100);
      });
    }

    // Event Handler
    window.addEventListener(
      'CookiebotOnAccept',
      function () {
        var bannerWasShown = sessionStorage.getItem('ablyft_banner_shown') === 'true';

        if (bannerWasShown) {
          window._ablyftConsentChanged = true;
          sessionStorage.setItem('ablyft_consent_changed', Date.now());
          sessionStorage.removeItem('ablyft_banner_shown');
        }
      },
      false
    );

    // Start Check
    checkIfBannerShown();
  })();
</script>

{% comment %} ABlyft Core Script - MIT Consent {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing" async src="https://cdn.ablyft.com/s/55886406.js"></script>

{% comment %} ABlyft Initialization Wait {% endcomment %}
<script type="text/plain" data-cookieconsent="marketing">
  (function () {
    'use strict';

    window['ablyft'] = window['ablyft'] || [];

    const CONFIG = {
      maxWaitTime: 500, // Max 500ms auf ABlyft warten
      checkInterval: 50, // Alle 50ms checken
      debug: false, // Auf false setzen für Production!
    };

    function log(message) {
      if (CONFIG.debug) {
        console.log('[ABlyft]', message);
      }
    }

    // Check ob ABlyft fertig ist
    function isAblyftReady() {
      // Check 1: Cookie gesetzt?
      if (document.cookie.match(/ablyft_exps=([^;]+)/)) {
        return true;
      }

      // Check 2: Window Object ready?
      if (window.ablyft && (window.ablyft._ready || window.ablyft._initialized || window.ablyft.experiments)) {
        return true;
      }

      return false;
    }

    // Warte auf ABlyft
    function waitForAblyft() {
      return new Promise(function (resolve) {
        var startTime = Date.now();
        var checks = 0;

        var interval = setInterval(function () {
          checks++;
          var elapsed = Date.now() - startTime;

          if (isAblyftReady()) {
            clearInterval(interval);
            log('ABlyft ready after ' + elapsed + 'ms');
            resolve(true);
            return;
          }

          if (elapsed >= CONFIG.maxWaitTime) {
            clearInterval(interval);
            log('Timeout after ' + elapsed + 'ms');
            resolve(false);
          }
        }, CONFIG.checkInterval);
      });
    }

    // Main Init
    function init() {
      // Check: Neuer Consent?
      var consentWasChanged = window._ablyftConsentChanged === true || sessionStorage.getItem('ablyft_consent_changed');

      // Lösche Flag
      try {
        sessionStorage.removeItem('ablyft_consent_changed');
      } catch (e) {}

      if (consentWasChanged) {
        log('New consent - waiting for ABlyft...');

        // Warte auf ABlyft, dann zeige Body
        waitForAblyft().then(function () {
          if (window.ablyftShowBody) {
            window.ablyftShowBody();
          }
        });
      } else {
        log('Existing consent - showing body');

        // Zeige Body sofort
        if (window.ablyftShowBody) {
          window.ablyftShowBody();
        }
      }
    }

    // Starte
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
